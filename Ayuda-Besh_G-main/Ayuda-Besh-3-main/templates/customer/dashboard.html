<!-- templates/customer/dashboard.html -->
{% extends "base.html" %}

{% block title %}Customer Dashboard - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer_dashboard.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/philippines_regions.js') }}"></script>
{% endblock %}

{% block content %}
<div class="customer-dashboard">
    <div class="dashboard-header">
        <h1>Customer Dashboard</h1>
        <div class="dashboard-actions" style="display: flex; align-items: center; gap: 15px;">
            <div style="position: relative;">
                <button id="notificationBell" onclick="toggleNotifications()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; position: relative; padding: 5px;">
                    üîî
                    <span id="notificationBadge" style="display: none; position: absolute; top: 0; right: 0; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;">0</span>
                </button>
                <div id="notificationsDropdown" style="display: none; position: absolute; right: 0; top: 45px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 300px; max-width: 400px; max-height: 500px; overflow-y: auto; z-index: 1000;">
                    <div style="padding: 15px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <strong>Notifications</strong>
                        <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: #0070f3; cursor: pointer; font-size: 0.85rem;">Mark all read</button>
                    </div>
                    <div id="notificationsList" style="padding: 10px;">
                        <p style="text-align: center; color: #6c757d; padding: 20px;">Loading notifications...</p>
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" onclick="window.location.href='/customer/book-service'">
                + Book Service
            </button>
            <button class="btn btn-outline" onclick="showProfileModal()">
                Profile Settings
            </button>
        </div>
    </div>

    <!-- Profile Section with Picture -->
    <div class="profile-section" id="profileSection">
        <img id="profilePicture" src="{{ url_for('static', filename='images/placeholder-user.jpg') }}" 
             alt="Profile Picture" class="profile-picture" onclick="showProfilePictureUpload()">
        <div class="profile-info">
            <script>
                const user = JSON.parse(localStorage.getItem('user') || 'null');
                if (user) {
                    document.write(`
                        <h3>${user.fullName || 'Customer'}</h3>
                        <p>${user.email || ''}</p>
                    `);
                }
            </script>
        </div>
    </div>

    <!-- Welcome Section -->
    <div class="welcome-section">
        <script>
            const user = JSON.parse(localStorage.getItem('user') || 'null');
            if (user) {
                document.write(`
                    <h2>Welcome back, ${user.fullName || 'Customer'}!</h2>
                    <p>Browse our verified service providers and book trusted professionals for your home service needs.</p>
                `);
            }
        </script>
    </div>

    <!-- Stats Section -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="totalBookings">0</div>
            <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="activeBookings">0</div>
            <div class="stat-label">Active Bookings</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="completedBookings">0</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalSpent">‚Ç±0</div>
            <div class="stat-label">Total Spent</div>
        </div>
    </div>

    <!-- Available Services Section -->
    <div class="content-section">
        <div class="section-header">
            <h2>Available Services</h2>
            <button class="btn btn-primary" onclick="window.location.href='/customer/book-service'">
                Browse All Services
            </button>
        </div>
        
        <!-- Location Filter -->
        <div class="filter-section">
            <div class="filter-group">
                <label for="locationFilter">Filter by Location:</label>
                <select id="locationFilter" onchange="loadAvailableServices()" style="min-width: 200px;">
                    <option value="">All Locations</option>
                </select>
                <label for="serviceTypeFilter">Service Type:</label>
                <select id="serviceTypeFilter" onchange="loadAvailableServices()">
                    <option value="">All Services</option>
                    <option value="cleaning">Domestic Cleaning</option>
                    <option value="plumbing">Plumbing</option>
                    <option value="electrical">Electrical Work</option>
                    <option value="pest_control">Pest Control</option>
                    <option value="appliance">Appliance Installation</option>
                    <option value="maintenance">General Maintenance</option>
                    <option value="online_services">Online Services</option>
                </select>
                <button class="btn btn-outline" onclick="getUserLocation()" style="padding: 10px 16px; font-size: 0.9rem;">
                    üìç Use My Location
                </button>
            </div>
        </div>
        
        <div id="availableServices" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px;">
            <p style="text-align: center; color: #6c757d; padding: 40px;">Loading available services...</p>
        </div>
    </div>

    <!-- Current Bookings Section -->
    <div class="content-section">
        <div class="section-header">
            <h2>My Bookings</h2>
            <div>
                <button class="btn btn-outline" onclick="window.location.href='/customer/booking-history'" style="margin-right: 10px;">
                    View All History
                </button>
                <button class="btn btn-outline" onclick="loadBookings()" style="padding: 10px 16px; font-size: 0.9rem;">
                    üîÑ Refresh
                </button>
            </div>
        </div>
        <div id="currentBookings">
            <p style="text-align: center; color: #6c757d; padding: 40px;">Loading your bookings...</p>
        </div>
    </div>

    <!-- Payment Transactions Section -->
    <div class="content-section">
        <div class="section-header">
            <h2>Payment Transactions</h2>
        </div>
        <div id="paymentTransactions">
            <p style="text-align: center; color: #6c757d; padding: 40px;">Loading payment history...</p>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #212529;">Profile Settings</h2>
            <span onclick="closeProfileModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
        </div>
        <div style="padding: 30px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <img id="modalProfilePicture" src="{{ url_for('static', filename='images/placeholder-user.jpg') }}" 
                     alt="Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #0070f3; cursor: pointer; margin-bottom: 15px;" 
                     onclick="document.getElementById('profilePictureInput').click()">
                <input type="file" id="profilePictureInput" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(event)">
                <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 0.9rem;">Click to upload profile picture</p>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Full Name</label>
                <input type="text" id="profileFullName" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Email</label>
                <input type="email" id="profileEmail" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Phone Number</label>
                <input type="tel" id="profilePhone" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Change Password</label>
                <input type="password" id="profilePassword" placeholder="Leave blank to keep current password" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
                <button onclick="showDeleteAccountModal()" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Delete Account
                </button>
                <button onclick="closeProfileModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin-left: 10px;">
                    Cancel
                </button>
                <button onclick="saveProfile()" style="background: #0070f3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div id="deleteAccountModal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 10% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 25px; border-bottom: 1px solid #e0e0e0;">
            <h2 style="margin: 0; color: #dc3545;">Delete Account</h2>
        </div>
        <div style="padding: 30px;">
            <p style="margin: 0 0 20px 0; color: #495057; line-height: 1.6;">
                Are you sure you want to delete your account? This action will request account deletion and requires admin approval. 
                Your account will be marked for deletion and you will be logged out.
            </p>
            <p style="margin: 0 0 20px 0; color: #856404; background: #fff3cd; padding: 12px; border-radius: 6px; border-left: 4px solid #ffc107;">
                <strong>Warning:</strong> This action cannot be undone. All your data will be permanently deleted after admin approval.
            </p>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                <button onclick="closeDeleteAccountModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="confirmDeleteAccount()" style="background: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Delete Account
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let userLocation = null;

// Get user's current location
function getUserLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                userLocation = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                // You can use this to filter providers by distance
                // For now, we'll just show a message
                alert('Location detected! Filtering providers near you...');
                loadAvailableServices();
            },
            (error) => {
                console.error('Error getting location:', error);
                alert('Unable to get your location. Please select a location manually.');
            }
        );
    } else {
        alert('Geolocation is not supported by your browser.');
    }
}

// Load available services from verified providers with filters
async function loadAvailableServices() {
    try {
        const locationFilter = document.getElementById('locationFilter')?.value || '';
        const serviceFilter = document.getElementById('serviceTypeFilter')?.value || '';
        
        let url = '/api/providers?verified=true';
        if (locationFilter) {
            url += `&location=${encodeURIComponent(locationFilter)}`;
        }
        if (serviceFilter) {
            url += `&service=${encodeURIComponent(serviceFilter)}`;
        }
        
        const token = localStorage.getItem('token');
        const headers = token ? {'Authorization': `Bearer ${token}`} : {};
        
        const response = await fetch(url, { headers });
        if (response.ok) {
            const providers = await response.json();
            // Transform providers to services format
            const services = providers.map(provider => ({
                provider_id: provider._id || provider.id,
                company_name: provider.username || provider.fullName,
                owner_name: provider.fullName,
                service_name: provider.services_offered?.[0] || 'Service',
                service_type: provider.services_offered?.[0] || '',
                description: provider.description || 'No description available',
                location: provider.location || 'Location not specified',
                hourly_rate: provider.hourly_rate || 0,
                rating: provider.rating || 0,
                is_verified: provider.is_verified || false
            }));
            displayServices(services);
        } else {
            document.getElementById('availableServices').innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No services available at the moment.</p>';
        }
    } catch (error) {
        console.error('Error loading services:', error);
        document.getElementById('availableServices').innerHTML = '<p style="text-align: center; color: #dc3545; padding: 40px;">Failed to load services. Please try again.</p>';
    }
}

function displayServices(services) {
    if (services.length === 0) {
        document.getElementById('availableServices').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <p style="font-size: 1.1rem; margin-bottom: 10px;">No verified service providers available</p>
                <p style="margin: 0;">Try adjusting your filters or check back later!</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    services.forEach(service => {
        const rating = service.rating || 0;
        const ratingDisplay = rating > 0 
            ? `<span class="rating-display">${'‚≠ê'.repeat(Math.floor(rating))} ${rating.toFixed(1)}/5</span>` 
            : '<span style="color: #6c757d; font-size: 0.85rem;">New Provider</span>';
        const verifiedBadge = service.is_verified 
            ? '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">Verified</span>' 
            : '';
        
        html += `
            <div class="service-card">
                <div style="flex-grow: 1;">
                    <h3 style="margin: 0 0 10px 0; color: #212529; font-size: 1.25rem; font-weight: 600; line-height: 1.4;">
                        ${service.company_name || 'Unknown Company'}${verifiedBadge}
                    </h3>
                    <p class="service-type">${(service.service_name || 'Service').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                    <p class="service-info" style="margin: 0 0 12px 0; color: #6c757d; font-size: 0.9rem;">
                        <strong>Owner:</strong> ${service.owner_name || 'Unknown Owner'}
                    </p>
                    <p class="service-info">
                        ${service.description && service.description.length > 120 ? service.description.substring(0, 120) + '...' : (service.description || 'No description available')}
                    </p>
                    <div class="service-meta">
                        <span>üìç ${service.location || 'Location not specified'}</span>
                        <span>${ratingDisplay}</span>
                    </div>
                    <div class="service-price">‚Ç±${service.hourly_rate || 0}/hr</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="viewProviderAvailability('${service.provider_id}')" 
                            class="btn btn-outline" 
                            style="flex: 1; padding: 10px; font-size: 0.85rem;">
                        View Schedule
                    </button>
                    <button onclick="bookService('${service.provider_id}', '${service.service_type}', ${service.hourly_rate || 0}, '${(service.company_name || service.owner_name || 'Provider').replace(/'/g, "\\'")}')" 
                            class="btn btn-primary" 
                            style="flex: 1; padding: 10px; font-size: 0.85rem;">
                        Book Now
                    </button>
                </div>
            </div>
        `;
    });
    document.getElementById('availableServices').innerHTML = html;
}

let selectedBookingProvider = null;

function bookService(providerId, serviceType, price, providerName) {
    // Show booking modal instead of redirecting
    selectedBookingProvider = {
        id: providerId,
        serviceType: serviceType,
        price: price,
        name: providerName || 'Provider'
    };
    
    // Populate modal with provider info
    document.getElementById('bookingProviderName').textContent = providerName || 'Provider';
    document.getElementById('bookingServiceType').textContent = serviceType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    document.getElementById('bookingPriceDisplay').textContent = price.toLocaleString();
    document.getElementById('selectedProviderIdHidden').value = providerId;
    document.getElementById('selectedServiceTypeHidden').value = serviceType;
    
    // Reset form
    document.getElementById('bookingTimeInput').value = '';
    document.getElementById('serviceAddressInput').value = '';
    document.getElementById('contactPhoneInput').value = '';
    document.getElementById('specialInstructionsInput').value = '';
    
    // Show modal
    document.getElementById('bookingModal').style.display = 'block';
}

// Load current bookings
async function loadBookings() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/my-bookings', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const bookings = await response.json();
            displayBookings(bookings);
            updateStats(bookings);
        } else {
            document.getElementById('currentBookings').innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">No active bookings found.</p>';
        }
    } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('currentBookings').innerHTML = '<p>Failed to load bookings. Please try again.</p>';
    }
}

function displayBookings(bookings) {
    if (bookings.length === 0) {
        document.getElementById('currentBookings').innerHTML = '<p>No active bookings found.</p>';
        return;
    }
    
    let html = '<div style="display: grid; gap: 15px;">';
    bookings.forEach(booking => {
        // Format date
        const bookingDate = new Date(booking.booking_time);
        const formattedDate = bookingDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // Status styling
        let statusColor = '#6c757d';
        if (booking.status === 'accepted') statusColor = '#28a745';
        else if (booking.status === 'completed') statusColor = '#17a2b8';
        else if (booking.status === 'pending') statusColor = '#ffc107';
        
        html += `
            <div style="border: 1px solid #ddd; padding: 15px; border-radius: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h4 style="margin: 0 0 10px 0; color: #333;">${booking.service_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                        <p><strong>Provider:</strong> ${booking.provider_name || booking.provider_company_name || 'Not assigned'}</p>
                        <p><strong>Date & Time:</strong> ${formattedDate}</p>
                        <p><strong>Price:</strong> ‚Ç±${booking.final_price || booking.price || 0}</p>
                        ${booking.rating ? `<p><strong>Your Rating:</strong> ${'‚≠ê'.repeat(booking.rating)} ${booking.rating}/5</p>` : ''}
                    </div>
                    <div style="text-align: right;">
                        <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">
                            ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
                        </span>
                        ${booking.status === 'accepted' ? 
                            `<div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
                                <button onclick="openSubmitReportModal('${booking._id}', '${booking.provider_id || ''}', '${(booking.provider_name || 'Provider').replace(/'/g, "\\'")}')" 
                                     style="background: #28a745; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    Submit Report
                                </button>
                                <button onclick="openSubmitDisputeModal('${booking._id}', '${booking.provider_id || ''}', '${(booking.provider_name || 'Provider').replace(/'/g, "\\'")}')" 
                                     style="background: #d9534f; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">
                                    Submit Dispute
                                </button>
                            </div>` : ''}
                        ${booking.status === 'completed' && !booking.rating ? 
                            `<button onclick="openRatingModal('${booking._id}', '${(booking.provider_name || booking.provider_company_name || 'Provider').replace(/'/g, "\\'")}')" 
                                 style="background: #ffc107; color: #333; padding: 8px 16px; border: none; border-radius: 4px; font-size: 13px; cursor: pointer; margin-top: 10px; font-weight: 600;">
                                ‚≠ê Rate Provider
                            </button>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    document.getElementById('currentBookings').innerHTML = html;
}

// Submit Report Modal
function openSubmitReportModal(bookingId, providerId, providerName) {
    document.getElementById('reportBookingId').value = bookingId;
    document.getElementById('reportProviderId').value = providerId;
    document.getElementById('reportProviderName').textContent = providerName;
    document.getElementById('reportDetails').value = '';
    document.getElementById('reportModal').style.display = 'block';
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

async function submitReport() {
    const bookingId = document.getElementById('reportBookingId').value;
    const providerId = document.getElementById('reportProviderId').value;
    const details = document.getElementById('reportDetails').value.trim();
    
    if (!details) {
        alert('Please provide report details');
        return;
    }
    
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    
    if (!token || !user) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/admin/reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                booking_id: bookingId,
                provider_id: providerId,
                customer_id: user.id,
                details: details,
                type: 'service_report'
            })
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Report submitted successfully! Admin will review it.');
            closeReportModal();
            loadBookings();
        } else {
            alert('Error: ' + (result.error || 'Failed to submit report'));
        }
    } catch (error) {
        console.error('Error submitting report:', error);
        alert('Network error. Please try again.');
    }
}

// Submit Dispute Modal
function openSubmitDisputeModal(bookingId, providerId, providerName) {
    document.getElementById('disputeBookingId').value = bookingId;
    document.getElementById('disputeProviderId').value = providerId;
    document.getElementById('disputeProviderName').textContent = providerName;
    document.getElementById('disputeDetails').value = '';
    document.getElementById('disputeModal').style.display = 'block';
}

function closeDisputeModal() {
    document.getElementById('disputeModal').style.display = 'none';
}

async function submitDispute() {
    const bookingId = document.getElementById('disputeBookingId').value;
    const providerId = document.getElementById('disputeProviderId').value;
    const details = document.getElementById('disputeDetails').value.trim();
    
    if (!details) {
        alert('Please provide dispute details');
        return;
    }
    
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    
    if (!token || !user) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/admin/disputes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                booking_id: bookingId,
                provider_id: providerId,
                customer_id: user.id,
                description: details
            })
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Dispute submitted successfully! Admin will review it.');
            closeDisputeModal();
            loadBookings();
        } else {
            alert('Error: ' + (result.error || 'Failed to submit dispute'));
        }
    } catch (error) {
        console.error('Error submitting dispute:', error);
        alert('Network error. Please try again.');
    }
}

// Rating Modal Functions
let currentRating = 0;
let currentRatingBookingId = null;

function openRatingModal(bookingId, providerName) {
    currentRatingBookingId = bookingId;
    document.getElementById('ratingProviderName').textContent = providerName;
    document.getElementById('ratingBookingId').value = bookingId;
    currentRating = 0;
    resetStars();
    document.getElementById('ratingModal').style.display = 'block';
}

function closeRatingModal() {
    document.getElementById('ratingModal').style.display = 'none';
    currentRating = 0;
    currentRatingBookingId = null;
    resetStars();
}

function setRating(rating) {
    currentRating = rating;
    updateStars(rating);
    document.getElementById('submitRatingBtn').disabled = false;
    
    const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
    };
    document.getElementById('ratingText').textContent = `${rating}/5 - ${ratingTexts[rating]}`;
}

function updateStars(rating) {
    for (let i = 1; i <= 5; i++) {
        const star = document.getElementById(`star${i}`);
        if (i <= rating) {
            star.style.color = '#ffc107';
        } else {
            star.style.color = '#ddd';
        }
    }
}

function resetStars() {
    for (let i = 1; i <= 5; i++) {
        document.getElementById(`star${i}`).style.color = '#ddd';
    }
    document.getElementById('ratingText').textContent = 'Click on a star to rate';
    document.getElementById('submitRatingBtn').disabled = true;
    if (document.getElementById('ratingComment')) {
        document.getElementById('ratingComment').value = '';
    }
}

async function submitRating() {
    if (currentRating === 0 || !currentRatingBookingId) {
        alert('Please select a rating');
        return;
    }

    const comment = document.getElementById('ratingComment').value.trim();
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/${currentRatingBookingId}/rate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
                rating: currentRating,
                review: comment || ''
            })
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Rating submitted successfully! ${result.average_rating ? `Provider's average rating is now ${result.average_rating.toFixed(1)}/5` : ''}`);
            closeRatingModal();
            loadBookings(); // Refresh bookings to show the rating
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to submit rating'));
        }
    } catch (error) {
        console.error('Error submitting rating:', error);
        alert('Network error. Please try again.');
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const reportModal = document.getElementById('reportModal');
    const disputeModal = document.getElementById('disputeModal');
    const ratingModal = document.getElementById('ratingModal');
    if (event.target == reportModal) {
        closeReportModal();
    }
    if (event.target == disputeModal) {
        closeDisputeModal();
    }
    if (event.target == ratingModal) {
        closeRatingModal();
    }
}

// Update stats
function updateStats(bookings) {
    if (!bookings || !Array.isArray(bookings)) return;
    
    const total = bookings.length;
    const active = bookings.filter(b => ['pending', 'accepted'].includes(b.status)).length;
    const completed = bookings.filter(b => b.status === 'completed').length;
    const totalSpent = bookings
        .filter(b => b.status === 'completed' || b.status === 'accepted')
        .reduce((sum, b) => sum + (b.final_price || b.price || 0), 0);
    
    if (document.getElementById('totalBookings')) {
        document.getElementById('totalBookings').textContent = total;
    }
    if (document.getElementById('activeBookings')) {
        document.getElementById('activeBookings').textContent = active;
    }
    if (document.getElementById('completedBookings')) {
        document.getElementById('completedBookings').textContent = completed;
    }
    if (document.getElementById('totalSpent')) {
        document.getElementById('totalSpent').textContent = `‚Ç±${totalSpent.toLocaleString()}`;
    }
}

// Profile Modal Functions
function showProfileModal() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('profileFullName').value = user.fullName || '';
    document.getElementById('profileEmail').value = user.email || '';
    document.getElementById('profilePhone').value = user.phone || '';
    document.getElementById('profilePassword').value = ''; // Clear password field
    
    // Load profile picture if available
    const profilePic = user.profile_picture || '{{ url_for("static", filename="images/placeholder-user.jpg") }}';
    document.getElementById('modalProfilePicture').src = profilePic;
    document.getElementById('profilePicture').src = profilePic;
    
    document.getElementById('profileModal').style.display = 'block';
}

function closeProfileModal() {
    document.getElementById('profileModal').style.display = 'none';
}

function showProfilePictureUpload() {
    document.getElementById('profilePictureInput').click();
}

async function handleProfilePictureUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        return;
    }
    
    // Preview image
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('modalProfilePicture').src = e.target.result;
        document.getElementById('profilePicture').src = e.target.result;
    };
    reader.readAsDataURL(file);
    
    // Upload to server
    const formData = new FormData();
    formData.append('profile_picture', file);
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch('/api/update-profile', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.user) {
                localStorage.setItem('user', JSON.stringify(result.user));
                // Update profile picture display immediately
                if (result.user.profile_picture) {
                    document.getElementById('modalProfilePicture').src = result.user.profile_picture;
                    document.getElementById('profilePicture').src = result.user.profile_picture;
                }
                alert('Profile picture uploaded successfully!');
            }
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to upload profile picture'));
        }
    } catch (error) {
        console.error('Error uploading profile picture:', error);
    }
}

async function saveProfile() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                fullName: document.getElementById('profileFullName').value,
                email: document.getElementById('profileEmail').value,
                phone: document.getElementById('profilePhone').value,
                password: document.getElementById('profilePassword').value || undefined
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.user) {
                localStorage.setItem('user', JSON.stringify(result.user));
                // Update profile picture if it changed
                if (result.user.profile_picture) {
                    document.getElementById('profilePicture').src = result.user.profile_picture;
                }
            }
            alert('Profile updated successfully!');
            closeProfileModal();
            // Reload to show updated data
            setTimeout(() => location.reload(), 500);
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to update profile'));
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Network error. Please try again.');
    }
}

// Account Deletion Functions
function showDeleteAccountModal() {
    document.getElementById('deleteAccountModal').style.display = 'block';
}

function closeDeleteAccountModal() {
    document.getElementById('deleteAccountModal').style.display = 'none';
}

async function confirmDeleteAccount() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    if (!confirm('Are you absolutely sure? This action requires admin approval and cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/delete-account', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                reason: 'User requested account deletion'
            })
        });
        
        if (response.ok) {
            alert('Account deletion requested. Admin approval is required. You will be logged out.');
            localStorage.clear();
            window.location.href = '/login';
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to request account deletion'));
        }
    } catch (error) {
        console.error('Error deleting account:', error);
        alert('Network error. Please try again.');
    }
}

// Booking Cancellation
async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
    }
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/${bookingId}/cancel`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        if (response.ok) {
            alert('Booking cancelled successfully');
            loadBookings();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to cancel booking'));
        }
    } catch (error) {
        console.error('Error cancelling booking:', error);
        alert('Network error. Please try again.');
    }
}

// View Provider Availability
async function viewProviderAvailability(providerId) {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/providers/${providerId}/availability`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        if (response.ok) {
            const availability = await response.json();
            showAvailabilityModal(availability);
        } else {
            alert('Unable to load provider availability');
        }
    } catch (error) {
        console.error('Error loading availability:', error);
        alert('Network error. Please try again.');
    }
}

function showAvailabilityModal(availability) {
    // Create and show availability modal
    alert('Provider availability feature - Schedule viewing will be implemented here');
    // TODO: Implement full availability calendar modal
}

// Load Payment Transactions
async function loadPaymentTransactions() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/payment-transactions', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const transactions = await response.json();
            displayPaymentTransactions(transactions);
        } else {
            // Fallback to old method if new endpoint doesn't exist
            const bookingsResponse = await fetch('/api/my-bookings', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (bookingsResponse.ok) {
                const bookings = await bookingsResponse.json();
                const transactions = bookings
                    .filter(b => b.status === 'completed' || b.status === 'accepted')
                    .map(b => ({
                        transaction_id: b._id,
                        booking_id: b._id,
                        date: b.booking_time || b.created_at,
                        amount: b.final_price || b.price || 0,
                        status: b.status,
                        payment_method: b.payment_method || 'face_to_face',
                        service_type: b.service_type,
                        provider_name: b.provider_name || b.provider_company_name
                    }));
                
                displayPaymentTransactions(transactions);
            }
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
        document.getElementById('paymentTransactions').innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">Failed to load payment history.</p>';
    }
}

function displayPaymentTransactions(transactions) {
    if (transactions.length === 0) {
        document.getElementById('paymentTransactions').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <p style="font-size: 1.1rem; margin-bottom: 10px;">No payment transactions yet</p>
                <p style="margin: 0;">Your completed bookings will appear here</p>
            </div>
        `;
        return;
    }
    
    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
    html += '<thead><tr style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">';
    html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Date</th>';
    html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Service</th>';
    html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Provider</th>';
    html += '<th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Amount</th>';
    html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Payment Method</th>';
    html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Status</th>';
    html += '</tr></thead><tbody>';
    
    transactions.forEach(transaction => {
        const dateStr = transaction.date || transaction.completed_at || transaction.created_at;
        const date = dateStr ? new Date(dateStr) : new Date();
        const formattedDate = date.toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const serviceType = transaction.service_type || transaction.service || 'N/A';
        const providerName = transaction.provider_name || transaction.provider || 'N/A';
        const amount = transaction.amount || 0;
        const paymentMethod = (transaction.payment_method || 'face_to_face').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
        const status = transaction.status || 'completed';
        
        html += '<tr style="border-bottom: 1px solid #e0e0e0; transition: background 0.2s;" onmouseover="this.style.background=\'#f8f9fa\'" onmouseout="this.style.background=\'transparent\'">';
        html += `<td style="padding: 12px; color: #495057;">${formattedDate}</td>`;
        html += `<td style="padding: 12px; color: #212529;">${serviceType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</td>`;
        html += `<td style="padding: 12px; color: #212529;">${providerName}</td>`;
        html += `<td style="padding: 12px; text-align: right; font-weight: 600; color: #0070f3;">‚Ç±${amount.toLocaleString()}</td>`;
        html += `<td style="padding: 12px; color: #6c757d;">${paymentMethod}</td>`;
        html += `<td style="padding: 12px;"><span class="status-badge status-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    document.getElementById('paymentTransactions').innerHTML = html;
}

// Update displayBookings to include cancel button
function displayBookings(bookings) {
    if (bookings.length === 0) {
        document.getElementById('currentBookings').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <p style="font-size: 1.1rem; margin-bottom: 10px;">No active bookings</p>
                <p style="margin: 0 0 20px 0;">Start booking services to see them here</p>
                <button class="btn btn-primary" onclick="window.location.href='/customer/book-service'">
                    Book a Service
                </button>
            </div>
        `;
        return;
    }
    
    let html = '<div style="display: grid; gap: 20px;">';
    bookings.forEach(booking => {
        const bookingDate = new Date(booking.booking_time || booking.created_at);
        const formattedDate = bookingDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        let statusClass = 'status-pending';
        if (booking.status === 'accepted') statusClass = 'status-accepted';
        else if (booking.status === 'completed') statusClass = 'status-completed';
        else if (booking.status === 'rejected') statusClass = 'status-rejected';
        
        const rating = booking.rating ? `<div class="rating-display" style="margin-top: 8px;">${'‚≠ê'.repeat(booking.rating)} ${booking.rating}/5</div>` : '';
        
        html += `
            <div class="booking-card">
                <div class="booking-header">
                    <div style="flex-grow: 1;">
                        <h3 class="booking-title">${(booking.service_type || 'Service').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                        <p class="booking-info"><strong>Provider:</strong> ${booking.provider_name || booking.provider_company_name || 'Not assigned'}</p>
                        <p class="booking-info"><strong>üìÖ Scheduled:</strong> ${formattedDate}</p>
                        ${booking.service_address ? `<p class="booking-info"><strong>üìç Address:</strong> ${booking.service_address}</p>` : ''}
                        <p class="booking-info"><strong>üí∞ Price:</strong> ‚Ç±${(booking.final_price || booking.price || 0).toLocaleString()}</p>
                        ${rating}
                    </div>
                    <div style="text-align: right;">
                        <span class="status-badge ${statusClass}">${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}</span>
                        ${['pending', 'accepted'].includes(booking.status) ? `
                            <button onclick="cancelBooking('${booking._id}')" 
                                    class="btn btn-outline" 
                                    style="margin-top: 10px; padding: 8px 16px; font-size: 0.85rem; background: #dc3545; color: white; border-color: #dc3545;">
                                Cancel Booking
                            </button>
                        ` : ''}
                        ${booking.status === 'completed' && !booking.rating ? `
                            <button onclick="openRatingModal('${booking._id}', '${(booking.provider_name || booking.provider_company_name || 'Provider').replace(/'/g, "\\'")}')" 
                                    class="btn btn-secondary" 
                                    style="margin-top: 10px; padding: 8px 16px; font-size: 0.85rem;">
                                ‚≠ê Rate Provider
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    document.getElementById('currentBookings').innerHTML = html;
}

// Close modals when clicking outside
window.onclick = function(event) {
    const profileModal = document.getElementById('profileModal');
    const deleteModal = document.getElementById('deleteAccountModal');
    if (event.target == profileModal) {
        closeProfileModal();
    }
    if (event.target == deleteModal) {
        closeDeleteAccountModal();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    // Populate location filter with Philippines regions
    const locationFilter = document.getElementById('locationFilter');
    if (locationFilter) {
        populateLocationFilter(locationFilter);
    }
    
    loadAvailableServices();
    loadBookings();
    loadPaymentTransactions();
    
    // Load user profile picture
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (user.profile_picture) {
        document.getElementById('profilePicture').src = user.profile_picture;
    }
    
    // Pre-fill contact phone from user profile
    if (user.phone) {
        const phoneInput = document.getElementById('contactPhoneInput');
        if (phoneInput) {
            phoneInput.value = user.phone;
        }
    }
    
    // Load notifications
    loadNotifications();
    // Refresh notifications every 30 seconds
    setInterval(loadNotifications, 30000);
});

// Notification functions
async function loadNotifications() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/notifications', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayNotifications(data.notifications || []);
            updateNotificationBadge(data.unread_count || 0);
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function displayNotifications(notifications) {
    const container = document.getElementById('notificationsList');
    if (!container) return;
    
    if (!notifications || notifications.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No notifications</p>';
        return;
    }
    
    let html = '';
    notifications.slice(0, 20).forEach(notif => {
        const date = new Date(notif.created_at);
        const typeColors = {
            'info': '#0070f3',
            'success': '#28a745',
            'warning': '#ffc107',
            'error': '#dc3545'
        };
        const bgColor = notif.read ? '#f8f9fa' : '#e3f2fd';
        
        html += `
            <div onclick="markNotificationRead('${notif._id}')" 
                 style="padding: 12px; border-bottom: 1px solid #e0e0e0; cursor: pointer; background: ${bgColor}; transition: background 0.2s;"
                 onmouseover="this.style.background='#f0f0f0'" 
                 onmouseout="this.style.background='${bgColor}'">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                    <div style="flex: 1;">
                        <strong style="color: ${typeColors[notif.type] || '#212529'}; display: block; margin-bottom: 4px;">${notif.title}</strong>
                        <p style="margin: 0; color: #6c757d; font-size: 0.9rem; line-height: 1.4;">${notif.message}</p>
                        <small style="color: #999; font-size: 0.75rem; display: block; margin-top: 6px;">${date.toLocaleString()}</small>
                    </div>
                    ${!notif.read ? '<span style="width: 8px; height: 8px; background: #0070f3; border-radius: 50%; flex-shrink: 0; margin-top: 4px;"></span>' : ''}
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if (badge) {
        if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'flex';
        } else {
            badge.style.display = 'none';
        }
    }
}

function toggleNotifications() {
    const dropdown = document.getElementById('notificationsDropdown');
    if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        if (dropdown.style.display === 'block') {
            loadNotifications();
        }
    }
}

async function markNotificationRead(notificationId) {
    const token = localStorage.getItem('token');
    try {
        await fetch(`/api/notifications/${notificationId}/read`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadNotifications();
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

async function markAllNotificationsRead() {
    const token = localStorage.getItem('token');
    try {
        await fetch('/api/notifications/read-all', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadNotifications();
    } catch (error) {
        console.error('Error marking all as read:', error);
    }
}

// Close notifications when clicking outside
window.addEventListener('click', function(event) {
    const bell = document.getElementById('notificationBell');
    const dropdown = document.getElementById('notificationsDropdown');
    if (dropdown && bell && !bell.contains(event.target) && !dropdown.contains(event.target)) {
        dropdown.style.display = 'none';
    }
});

function closeBookingModal() {
    document.getElementById('bookingModal').style.display = 'none';
    selectedBookingProvider = null;
}

async function confirmBookingFromModal() {
    const bookingTime = document.getElementById('bookingTimeInput').value;
    const serviceAddress = document.getElementById('serviceAddressInput').value.trim();
    const contactPhone = document.getElementById('contactPhoneInput').value.trim();
    const specialInstructions = document.getElementById('specialInstructionsInput').value.trim();
    const providerId = document.getElementById('selectedProviderIdHidden').value;
    const serviceType = document.getElementById('selectedServiceTypeHidden').value;
    
    // Validation
    if (!bookingTime) {
        alert('Please select a booking date and time');
        document.getElementById('bookingTimeInput').focus();
        return;
    }
    
    const selectedDate = new Date(bookingTime);
    if (selectedDate < new Date()) {
        alert('Please select a future date and time');
        document.getElementById('bookingTimeInput').focus();
        return;
    }
    
    if (!serviceAddress) {
        alert('Please enter the service address');
        document.getElementById('serviceAddressInput').focus();
        return;
    }
    
    if (!contactPhone) {
        alert('Please enter your contact phone number');
        document.getElementById('contactPhoneInput').focus();
        return;
    }
    
    if (!selectedBookingProvider || !providerId) {
        alert('Provider information is missing. Please try again.');
        return;
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    
    if (!user || !token) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    const confirmBtn = event.target;
    const originalText = confirmBtn.textContent;
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Processing...';
    
    try {
        const isoDateTime = new Date(bookingTime).toISOString();
        
        const response = await fetch('/api/book', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                customer_id: user.id,
                customer_name: user.fullName,
                customer_email: user.email,
                customer_phone: contactPhone,
                provider_id: providerId,
                service_type: serviceType,
                booking_time: isoDateTime,
                service_address: serviceAddress,
                special_instructions: specialInstructions,
                price: selectedBookingProvider.price
            })
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            throw new Error('Server returned non-JSON response. Please try again.');
        }
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to create booking');
        }
        
        alert('‚úÖ Booking created successfully! The provider will be notified.');
        closeBookingModal();
        loadBookings(); // Refresh bookings list
        loadAvailableServices(); // Refresh services
    } catch (error) {
        console.error('Booking error:', error);
        alert('Error: ' + (error.message || 'Failed to create booking. Please try again.'));
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const bookingModal = document.getElementById('bookingModal');
    if (event.target == bookingModal) {
        closeBookingModal();
    }
}
</script>

<!-- Submit Report Modal -->
<div id="reportModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #333;">Submit Report</h2>
            <span onclick="closeReportModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
        </div>
        <div style="padding: 20px;">
            <input type="hidden" id="reportBookingId">
            <input type="hidden" id="reportProviderId">
            <p style="margin: 0 0 15px 0;"><strong>Provider:</strong> <span id="reportProviderName"></span></p>
            <div style="margin-bottom: 15px;">
                <label for="reportDetails" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Report Details <span style="color: red;">*</span></label>
                <textarea id="reportDetails" rows="6" placeholder="Please provide details about the service, any issues encountered, or feedback..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; box-sizing: border-box; font-family: inherit;" required></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" onclick="closeReportModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
                <button type="button" onclick="submitReport()" style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                    Submit Report
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Submit Dispute Modal -->
<div id="disputeModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #333;">Submit Dispute</h2>
            <span onclick="closeDisputeModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
        </div>
        <div style="padding: 20px;">
            <input type="hidden" id="disputeBookingId">
            <input type="hidden" id="disputeProviderId">
            <p style="margin: 0 0 15px 0;"><strong>Provider:</strong> <span id="disputeProviderName"></span></p>
            <div style="margin-bottom: 15px;">
                <label for="disputeDetails" style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Dispute Details <span style="color: red;">*</span></label>
                <textarea id="disputeDetails" rows="6" placeholder="Please describe the issue or problem you encountered with this service..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; box-sizing: border-box; font-family: inherit;" required></textarea>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" onclick="closeDisputeModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
                <button type="button" onclick="submitDispute()" style="background: #d9534f; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                    Submit Dispute
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Rating Modal -->
<div id="ratingModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #333;">Rate Your Provider</h2>
            <span onclick="closeRatingModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
        </div>
        <div style="padding: 30px; text-align: center;">
            <p style="margin: 0 0 30px 0; font-size: 16px; color: #666;">How would you rate <strong id="ratingProviderName" style="color: #333;"></strong>?</p>
            <input type="hidden" id="ratingBookingId">
            <div style="margin: 30px 0;">
                <div id="starRating" style="font-size: 48px; cursor: pointer; user-select: none; display: flex; justify-content: center; gap: 10px;">
                    <span onclick="setRating(1)" id="star1" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                    <span onclick="setRating(2)" id="star2" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                    <span onclick="setRating(3)" id="star3" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                    <span onclick="setRating(4)" id="star4" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                    <span onclick="setRating(5)" id="star5" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                </div>
                <p id="ratingText" style="margin-top: 20px; font-size: 18px; color: #666; font-weight: 500;">Click on a star to rate</p>
            </div>
            <div style="margin-top: 30px; text-align: left;">
                <label for="ratingComment" style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">Add a comment (optional):</label>
                <textarea id="ratingComment" rows="4" placeholder="Share your experience with this provider..." style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box; resize: vertical; font-family: inherit;" maxlength="1000"></textarea>
                <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Maximum 1000 characters</small>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                <button type="button" onclick="closeRatingModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
                <button type="button" onclick="submitRating()" id="submitRatingBtn" disabled style="background: #ffc107; color: #333; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    Submit Rating
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Booking Modal -->
<div id="bookingModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
            <h2 style="margin: 0; color: #212529; font-size: 1.5rem; font-weight: 700;">Book Service</h2>
            <span onclick="closeBookingModal()" style="color: #6c757d; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 20px; transition: color 0.2s;" onmouseover="this.style.color='#dc3545'" onmouseout="this.style.color='#6c757d'">&times;</span>
        </div>
        <div style="padding: 30px; max-height: 70vh; overflow-y: auto;">
            <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                <h3 style="margin: 0 0 10px 0; color: #155724; font-size: 1.2rem;">Provider: <span id="bookingProviderName"></span></h3>
                <p style="margin: 5px 0; color: #2e7d32;"><strong>Service:</strong> <span id="bookingServiceType"></span></p>
                <p style="margin: 5px 0; color: #2e7d32;"><strong>Rate:</strong> ‚Ç±<span id="bookingPriceDisplay"></span>/hr</p>
            </div>
            
            <input type="hidden" id="selectedProviderIdHidden">
            <input type="hidden" id="selectedServiceTypeHidden">
            
            <div class="form-group">
                <label for="bookingTimeInput">Booking Date & Time <span style="color: #dc3545;">*</span></label>
                <input type="datetime-local" id="bookingTimeInput" required style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
                <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Select when you need the service</small>
            </div>
            
            <div class="form-group">
                <label for="serviceAddressInput">Service Address <span style="color: #dc3545;">*</span></label>
                <textarea id="serviceAddressInput" rows="3" required placeholder="Enter complete address including street, barangay, city" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box; resize: vertical;"></textarea>
                <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Include street, barangay, city for accurate location</small>
            </div>
            
            <div class="form-group">
                <label for="contactPhoneInput">Contact Phone Number <span style="color: #dc3545;">*</span></label>
                <input type="tel" id="contactPhoneInput" required placeholder="+63 912 345 6789" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
                <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Provider will contact you at this number</small>
            </div>
            
            <div class="form-group">
                <label for="specialInstructionsInput">Special Instructions or Notes</label>
                <textarea id="specialInstructionsInput" rows="4" placeholder="Any special requirements, access instructions, or details the provider should know..." style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box; resize: vertical;"></textarea>
                <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Optional: Add any specific requirements or instructions</small>
            </div>
            
            <div style="display: flex; gap: 12px; margin-top: 30px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
                <button onclick="closeBookingModal()" class="btn btn-outline" style="flex: 1;">
                    Cancel
                </button>
                <button onclick="confirmBookingFromModal()" class="btn btn-primary" style="flex: 2; padding: 14px 24px; font-size: 1rem;">
                    Confirm Booking
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}