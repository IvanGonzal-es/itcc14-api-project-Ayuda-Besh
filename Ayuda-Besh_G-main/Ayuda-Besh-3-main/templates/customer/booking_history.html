<!-- templates/customer/booking_history.html -->
{% extends "base.html" %}

{% block title %}Booking History - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer_dashboard.css') }}">
<style>
.booking-history-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
    background: #f8f9fa;
    min-height: calc(100vh - 60px);
}

.filter-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.filter-tab {
    padding: 10px 20px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    color: #495057;
    transition: all 0.3s ease;
}

.filter-tab:hover {
    border-color: #0070f3;
    color: #0070f3;
}

.filter-tab.active {
    background: #0070f3;
    color: white;
    border-color: #0070f3;
}

.booking-card-detailed {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.booking-card-detailed:hover {
    border-color: #0070f3;
    box-shadow: 0 4px 16px rgba(0, 112, 243, 0.1);
}

.booking-header-detailed {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.booking-title-detailed {
    font-size: 1.35rem;
    font-weight: 700;
    color: #212529;
    margin: 0 0 12px 0;
}

.booking-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
}

.info-item {
    display: flex;
    align-items: flex-start;
    gap: 8px;
}

.info-item strong {
    color: #495057;
    font-weight: 600;
    min-width: 100px;
}

.info-item span {
    color: #6c757d;
    flex: 1;
}

.booking-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

.stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}
</style>
{% endblock %}

{% block content %}
<div class="booking-history-container">
    <div class="dashboard-header">
        <h1>My Booking History</h1>
        <div class="dashboard-actions">
            <button class="btn btn-outline" onclick="window.location.href='/customer/dashboard'">
                ‚Üê Back to Dashboard
            </button>
            <button class="btn btn-primary" onclick="loadBookings()">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="stats-summary" id="statsSummary" style="display: none;">
        <div class="stat-card">
            <div class="stat-value" id="totalBookingsCount">0</div>
            <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="completedCount">0</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="pendingCount">0</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalSpentAmount">‚Ç±0</div>
            <div class="stat-label">Total Spent</div>
        </div>
    </div>

    <!-- Booking History Section -->
    <div class="content-section">
        <div class="section-header">
            <h2>All Bookings</h2>
        </div>
        
        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <div class="filter-tab active" onclick="filterBookings('all')">All</div>
            <div class="filter-tab" onclick="filterBookings('pending')">Pending</div>
            <div class="filter-tab" onclick="filterBookings('accepted')">Accepted</div>
            <div class="filter-tab" onclick="filterBookings('completed')">Completed</div>
            <div class="filter-tab" onclick="filterBookings('rejected')">Rejected</div>
        </div>
        
        <div id="bookingsList">
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <p style="font-size: 1.1rem; margin: 0;">Loading your bookings...</p>
            </div>
        </div>
    </div>
</div>

<script>
let allBookings = [];
let currentFilter = 'all';

async function loadBookings() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/login';
        return;
    }

    // Show loading state
    document.getElementById('bookingsList').innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
            <p style="font-size: 1.1rem; margin: 0;">Loading your bookings...</p>
        </div>
    `;

    try {
        const response = await fetch('/api/my-bookings', {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            allBookings = await response.json();
            updateStats(allBookings);
            filterBookings(currentFilter);
        } else {
            const error = await response.json();
            document.getElementById('bookingsList').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
                    <p style="font-size: 1.1rem; margin: 0;">Error: ${error.error || 'Failed to load bookings'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading bookings:', error);
        document.getElementById('bookingsList').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
                <p style="font-size: 1.1rem; margin: 0;">Network error. Please try again.</p>
            </div>
        `;
    }
}

function filterBookings(status) {
    currentFilter = status;
    
    // Update active tab
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event?.target?.classList.add('active');
    
    // Filter bookings
    let filteredBookings = allBookings;
    if (status !== 'all') {
        filteredBookings = allBookings.filter(b => b.status === status);
    }
    
    displayBookings(filteredBookings);
}

function updateStats(bookings) {
    if (!bookings || !Array.isArray(bookings)) return;
    
    const total = bookings.length;
    const completed = bookings.filter(b => b.status === 'completed').length;
    const pending = bookings.filter(b => ['pending', 'accepted'].includes(b.status)).length;
    const totalSpent = bookings
        .filter(b => b.status === 'completed')
        .reduce((sum, b) => sum + (b.final_price || b.price || 0), 0);
    
    if (total > 0) {
        document.getElementById('statsSummary').style.display = 'grid';
        document.getElementById('totalBookingsCount').textContent = total;
        document.getElementById('completedCount').textContent = completed;
        document.getElementById('pendingCount').textContent = pending;
        document.getElementById('totalSpentAmount').textContent = `‚Ç±${totalSpent.toLocaleString()}`;
    }
}

function displayBookings(bookings) {
    if (bookings.length === 0) {
        const filterText = currentFilter === 'all' ? '' : ` with status "${currentFilter}"`;
        document.getElementById('bookingsList').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <p style="font-size: 1.25rem; margin-bottom: 10px; font-weight: 600;">No bookings${filterText}</p>
                <p style="margin-bottom: 25px;">${currentFilter === 'all' ? 'Start booking services to see your history here.' : 'Try selecting a different filter.'}</p>
                ${currentFilter === 'all' ? `
                    <button class="btn btn-primary" onclick="window.location.href='/customer/book-service'">
                        Book a Service
                    </button>
                ` : `
                    <button class="btn btn-outline" onclick="filterBookings('all')">
                        View All Bookings
                    </button>
                `}
            </div>
        `;
        return;
    }

    // Sort bookings by date (newest first)
    bookings.sort((a, b) => {
        const dateA = new Date(a.created_at || a.booking_time);
        const dateB = new Date(b.created_at || b.booking_time);
        return dateB - dateA;
    });

    let html = '';
    
    bookings.forEach(booking => {
        const bookingDate = new Date(booking.booking_time || booking.created_at);
        const formattedDate = bookingDate.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const createdDate = booking.created_at ? new Date(booking.created_at).toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        }) : 'N/A';

        let statusClass = 'status-pending';
        if (booking.status === 'accepted') statusClass = 'status-accepted';
        else if (booking.status === 'completed') statusClass = 'status-completed';
        else if (booking.status === 'rejected') statusClass = 'status-rejected';

        const serviceType = booking.service_type ? booking.service_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Service';
        const finalPrice = booking.final_price || booking.price || 0;
        const priceDisplay = booking.final_price ? `‚Ç±${finalPrice.toLocaleString()} (Final)` : `‚Ç±${finalPrice.toLocaleString()} (Estimated)`;
        const providerName = booking.provider_name || booking.provider_company_name || 'Not assigned';
        const rating = booking.rating ? `<div class="rating-display" style="margin-top: 8px;">${'‚≠ê'.repeat(booking.rating)} ${booking.rating}/5</div>` : '';

        html += `
            <div class="booking-card-detailed">
                <div class="booking-header-detailed">
                    <div style="flex-grow: 1;">
                        <h3 class="booking-title-detailed">${serviceType}</h3>
                        <span class="status-badge ${statusClass}">${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}</span>
                    </div>
                    ${rating}
                </div>
                
                <div class="booking-info-grid">
                    <div class="info-item">
                        <strong>Provider:</strong>
                        <span>${providerName}</span>
                    </div>
                    <div class="info-item">
                        <strong>üìÖ Scheduled:</strong>
                        <span>${formattedDate}</span>
                    </div>
                    <div class="info-item">
                        <strong>üí∞ Price:</strong>
                        <span style="font-weight: 600; color: #0070f3;">${priceDisplay}</span>
                    </div>
                    <div class="info-item">
                        <strong>üìÜ Booked:</strong>
                        <span>${createdDate}</span>
                    </div>
                    ${booking.service_address ? `
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <strong>üìç Address:</strong>
                            <span>${booking.service_address}</span>
                        </div>
                    ` : ''}
                    ${booking.special_instructions ? `
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <strong>üìù Notes:</strong>
                            <span>${booking.special_instructions}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="booking-actions">
                    ${booking.status === 'completed' && !booking.rating ? `
                        <button onclick="openRatingModal('${booking._id}', '${providerName.replace(/'/g, "\\'")}')" 
                                class="btn btn-secondary">
                            ‚≠ê Rate Provider
                        </button>
                    ` : ''}
                    ${['pending', 'accepted'].includes(booking.status) ? `
                        <button onclick="cancelBooking('${booking._id}')" 
                                class="btn btn-outline" 
                                style="background: #dc3545; color: white; border-color: #dc3545;">
                            Cancel Booking
                        </button>
                    ` : ''}
                    ${booking.status === 'accepted' ? `
                        <button onclick="openSubmitReportModal('${booking._id}', '${booking.provider_id || ''}', '${providerName.replace(/'/g, "\\'")}')" 
                                class="btn btn-outline">
                            Submit Report
                        </button>
                        <button onclick="openSubmitDisputeModal('${booking._id}', '${booking.provider_id || ''}', '${providerName.replace(/'/g, "\\'")}')" 
                                class="btn btn-outline" 
                                style="background: #dc3545; color: white; border-color: #dc3545;">
                            Submit Dispute
                        </button>
                    ` : ''}
                </div>
            </div>
        `;
    });

    document.getElementById('bookingsList').innerHTML = html;
}

// Cancel booking function
async function cancelBooking(bookingId) {
    if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
    }
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/${bookingId}/cancel`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        if (response.ok) {
            alert('Booking cancelled successfully');
            loadBookings();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to cancel booking'));
        }
    } catch (error) {
        console.error('Error cancelling booking:', error);
        alert('Network error. Please try again.');
    }
}

// Rating Modal Functions (reuse from dashboard)
let currentRating = 0;
let currentRatingBookingId = null;

function openRatingModal(bookingId, providerName) {
    currentRatingBookingId = bookingId;
    document.getElementById('ratingProviderName').textContent = providerName;
    document.getElementById('ratingBookingId').value = bookingId;
    currentRating = 0;
    resetStars();
    document.getElementById('ratingModal').style.display = 'block';
}

function closeRatingModal() {
    document.getElementById('ratingModal').style.display = 'none';
    currentRating = 0;
    currentRatingBookingId = null;
    resetStars();
}

function setRating(rating) {
    currentRating = rating;
    updateStars(rating);
    document.getElementById('submitRatingBtn').disabled = false;
    
    const ratingTexts = {
        1: 'Poor',
        2: 'Fair',
        3: 'Good',
        4: 'Very Good',
        5: 'Excellent'
    };
    document.getElementById('ratingText').textContent = `${rating}/5 - ${ratingTexts[rating]}`;
}

function updateStars(rating) {
    for (let i = 1; i <= 5; i++) {
        const star = document.getElementById(`star${i}`);
        if (star) {
            star.style.color = i <= rating ? '#ffc107' : '#ddd';
        }
    }
}

function resetStars() {
    for (let i = 1; i <= 5; i++) {
        const star = document.getElementById(`star${i}`);
        if (star) {
            star.style.color = '#ddd';
        }
    }
    if (document.getElementById('ratingText')) {
        document.getElementById('ratingText').textContent = 'Click on a star to rate';
    }
    if (document.getElementById('submitRatingBtn')) {
        document.getElementById('submitRatingBtn').disabled = true;
    }
    if (document.getElementById('ratingComment')) {
        document.getElementById('ratingComment').value = '';
    }
}

async function submitRating() {
    if (currentRating === 0 || !currentRatingBookingId) {
        alert('Please select a rating');
        return;
    }

    const token = localStorage.getItem('token');
    try {
        const comment = document.getElementById('ratingComment') ? document.getElementById('ratingComment').value.trim() : '';
        const response = await fetch(`/api/${currentRatingBookingId}/rate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
                rating: currentRating,
                review: comment || ''
            })
        });

        if (response.ok) {
            const result = await response.json();
            alert(`Rating submitted successfully! ${result.average_rating ? `Provider's average rating is now ${result.average_rating.toFixed(1)}/5` : ''}`);
            closeRatingModal();
            loadBookings();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to submit rating'));
        }
    } catch (error) {
        console.error('Error submitting rating:', error);
        alert('Network error. Please try again.');
    }
}

// Report and Dispute functions (reuse from dashboard)
function openSubmitReportModal(bookingId, providerId, providerName) {
    // Create modal if it doesn't exist
    if (!document.getElementById('reportModal')) {
        createReportModal();
    }
    document.getElementById('reportBookingId').value = bookingId;
    document.getElementById('reportProviderId').value = providerId;
    document.getElementById('reportProviderName').textContent = providerName;
    document.getElementById('reportDetails').value = '';
    document.getElementById('reportModal').style.display = 'block';
}

function openSubmitDisputeModal(bookingId, providerId, providerName) {
    // Create modal if it doesn't exist
    if (!document.getElementById('disputeModal')) {
        createDisputeModal();
    }
    document.getElementById('disputeBookingId').value = bookingId;
    document.getElementById('disputeProviderId').value = providerId;
    document.getElementById('disputeProviderName').textContent = providerName;
    document.getElementById('disputeDetails').value = '';
    document.getElementById('disputeModal').style.display = 'block';
}

function createReportModal() {
    const modal = document.createElement('div');
    modal.id = 'reportModal';
    modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;';
    modal.innerHTML = `
        <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #212529;">Submit Report</h2>
                <span onclick="closeReportModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
            </div>
            <div style="padding: 30px;">
                <input type="hidden" id="reportBookingId">
                <input type="hidden" id="reportProviderId">
                <p style="margin: 0 0 15px 0;"><strong>Provider:</strong> <span id="reportProviderName"></span></p>
                <div class="form-group">
                    <label for="reportDetails">Report Details <span style="color: #dc3545;">*</span></label>
                    <textarea id="reportDetails" rows="6" placeholder="Please provide details about the service, any issues encountered, or feedback..." required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button onclick="closeReportModal()" class="btn btn-outline">Cancel</button>
                    <button onclick="submitReport()" class="btn btn-primary">Submit Report</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function createDisputeModal() {
    const modal = document.createElement('div');
    modal.id = 'disputeModal';
    modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;';
    modal.innerHTML = `
        <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #212529;">Submit Dispute</h2>
                <span onclick="closeDisputeModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
            </div>
            <div style="padding: 30px;">
                <input type="hidden" id="disputeBookingId">
                <input type="hidden" id="disputeProviderId">
                <p style="margin: 0 0 15px 0;"><strong>Provider:</strong> <span id="disputeProviderName"></span></p>
                <div class="form-group">
                    <label for="disputeDetails">Dispute Details <span style="color: #dc3545;">*</span></label>
                    <textarea id="disputeDetails" rows="6" placeholder="Please describe the issue or problem you encountered with this service..." required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                    <button onclick="closeDisputeModal()" class="btn btn-outline">Cancel</button>
                    <button onclick="submitDispute()" class="btn btn-outline" style="background: #dc3545; color: white; border-color: #dc3545;">Submit Dispute</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeReportModal() {
    if (document.getElementById('reportModal')) {
        document.getElementById('reportModal').style.display = 'none';
    }
}

function closeDisputeModal() {
    if (document.getElementById('disputeModal')) {
        document.getElementById('disputeModal').style.display = 'none';
    }
}

async function submitReport() {
    const bookingId = document.getElementById('reportBookingId').value;
    const providerId = document.getElementById('reportProviderId').value;
    const details = document.getElementById('reportDetails').value.trim();
    
    if (!details) {
        alert('Please provide report details');
        return;
    }
    
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    
    if (!token || !user) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/admin/reports', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                booking_id: bookingId,
                provider_id: providerId,
                customer_id: user.id,
                details: details,
                type: 'service_report'
            })
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Report submitted successfully! Admin will review it.');
            closeReportModal();
            loadBookings();
        } else {
            alert('Error: ' + (result.error || 'Failed to submit report'));
        }
    } catch (error) {
        console.error('Error submitting report:', error);
        alert('Network error. Please try again.');
    }
}

async function submitDispute() {
    const bookingId = document.getElementById('disputeBookingId').value;
    const providerId = document.getElementById('disputeProviderId').value;
    const details = document.getElementById('disputeDetails').value.trim();
    
    if (!details) {
        alert('Please provide dispute details');
        return;
    }
    
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user'));
    
    if (!token || !user) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    try {
        const response = await fetch('/api/admin/disputes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                booking_id: bookingId,
                provider_id: providerId,
                customer_id: user.id,
                description: details
            })
        });
        
        const result = await response.json();
        if (response.ok) {
            alert('Dispute submitted successfully! Admin will review it.');
            closeDisputeModal();
            loadBookings();
        } else {
            alert('Error: ' + (result.error || 'Failed to submit dispute'));
        }
    } catch (error) {
        console.error('Error submitting dispute:', error);
        alert('Network error. Please try again.');
    }
}

// Rating Modal HTML (will be created dynamically if needed)
function createRatingModal() {
    if (document.getElementById('ratingModal')) return;
    
    const modal = document.createElement('div');
    modal.id = 'ratingModal';
    modal.style.cssText = 'display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;';
    modal.innerHTML = `
        <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
            <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; color: #212529;">Rate Your Provider</h2>
                <span onclick="closeRatingModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
            </div>
            <div style="padding: 30px; text-align: center;">
                <p style="margin: 0 0 30px 0; font-size: 16px; color: #6c757d;">How would you rate <strong id="ratingProviderName" style="color: #212529;"></strong>?</p>
                <input type="hidden" id="ratingBookingId">
                <div style="margin: 30px 0;">
                    <div id="starRating" style="font-size: 48px; cursor: pointer; user-select: none; display: flex; justify-content: center; gap: 10px;">
                        <span onclick="setRating(1)" id="star1" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                        <span onclick="setRating(2)" id="star2" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                        <span onclick="setRating(3)" id="star3" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                        <span onclick="setRating(4)" id="star4" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                        <span onclick="setRating(5)" id="star5" style="color: #ddd; transition: color 0.2s;">‚òÖ</span>
                    </div>
                    <p id="ratingText" style="margin-top: 20px; font-size: 18px; color: #6c757d; font-weight: 500;">Click on a star to rate</p>
                </div>
                <div style="margin-top: 30px; text-align: left;">
                    <label for="ratingComment" style="display: block; margin-bottom: 8px; color: #333; font-weight: 500;">Add a comment (optional):</label>
                    <textarea id="ratingComment" rows="4" placeholder="Share your experience with this provider..." style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box; resize: vertical; font-family: inherit;" maxlength="1000"></textarea>
                    <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Maximum 1000 characters</small>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                    <button onclick="closeRatingModal()" class="btn btn-outline">Cancel</button>
                    <button onclick="submitRating()" id="submitRatingBtn" disabled class="btn btn-secondary">Submit Rating</button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// Close modals when clicking outside
window.onclick = function(event) {
    const ratingModal = document.getElementById('ratingModal');
    const reportModal = document.getElementById('reportModal');
    const disputeModal = document.getElementById('disputeModal');
    if (event.target == ratingModal) {
        closeRatingModal();
    }
    if (event.target == reportModal) {
        closeReportModal();
    }
    if (event.target == disputeModal) {
        closeDisputeModal();
    }
}

// Load bookings when page loads
document.addEventListener('DOMContentLoaded', () => {
    createRatingModal();
    createReportModal();
    createDisputeModal();
    loadBookings();
});
</script>
{% endblock %}

