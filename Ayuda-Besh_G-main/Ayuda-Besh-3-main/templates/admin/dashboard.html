<!-- templates/admin/dashboard.html -->
{% extends "base.html" %}

{% block title %}Admin Dashboard - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer_dashboard.css') }}">
<style>
.dashboard-main {
    display: block;
    grid-template-columns: unset;
    grid-template-rows: unset;
}
</style>
{% endblock %}

{% block content %}
<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; overflow: hidden;">
<div class="admin-dashboard">
    <header class="dashboard-header">
        <div style="display: flex; align-items: center; gap: 10px;">
            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo" class="logo" onerror="this.style.display='none'">
            <span style="font-size: 1.2rem; font-weight: bold; color: #333;">AyudaBesh</span>
        </div>
        <div style="display: flex; align-items: center; gap: 20px;">
            <div id="adminProfileSection" style="display: flex; align-items: center; gap: 10px;">
                <img id="adminProfilePicture" src="{{ url_for('static', filename='images/placeholder-user.jpg') }}" 
                     alt="Profile" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 2px solid #0070f3;" 
                     onclick="showAdminProfileModal()">
                <span id="adminName" style="font-weight: 600; color: #212529;">Admin</span>
            </div>
            <div style="position: relative;">
                <button id="notificationBell" onclick="toggleNotifications()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; position: relative;">
                    üîî
                    <span id="notificationBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: #dc3545; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center;">0</span>
                </button>
                <div id="notificationsDropdown" style="display: none; position: absolute; right: 0; top: 40px; background: white; border: 1px solid #e0e0e0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 300px; max-width: 400px; max-height: 500px; overflow-y: auto; z-index: 1000;">
                    <div style="padding: 15px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <strong>Notifications</strong>
                        <button onclick="markAllNotificationsRead()" style="background: none; border: none; color: #0070f3; cursor: pointer; font-size: 0.85rem;">Mark all read</button>
                    </div>
                    <div id="notificationsList" style="padding: 10px;">
                        <p style="text-align: center; color: #6c757d; padding: 20px;">Loading notifications...</p>
                    </div>
                </div>
            </div>
            <button class="logout-button" onclick="logout()">Logout</button>
        </div>
    </header>

    <aside class="sidebar">
        <nav class="sidebar-nav">
            <a href="/admin/dashboard" class="nav-item active" onclick="refreshAdminProfile(); return true;">Dashboard</a>
            <a href="/admin/provider-verification" class="nav-item" onclick="refreshAdminProfile(); return true;">Providers</a>
            <a href="/admin/dispute-management" class="nav-item" onclick="refreshAdminProfile(); return true;">Disputes</a>
            <a href="/admin/reports" class="nav-item" onclick="refreshAdminProfile(); return true;">Reports</a>
        </nav>
    </aside>

    <main class="dashboard-main">
        <!-- Analytics Overview -->
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="stat-card">
                <div class="stat-value" style="color: #0070f3;"><span id="totalBookings">0</span></div>
                <div class="stat-label">Total Bookings</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #28a745;">‚Ç±<span id="totalRevenue">0</span></div>
                <div class="stat-label">Total Revenue</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #17a2b8;"><span id="activeProviders">0</span></div>
                <div class="stat-label">Active Providers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #ffc107;"><span id="totalCustomers">0</span></div>
                <div class="stat-label">Total Customers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #dc3545;"><span id="openDisputes">0</span></div>
                <div class="stat-label">Open Disputes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" style="color: #6f42c1;"><span id="avgRating">0</span></div>
                <div class="stat-label">Average Rating</div>
            </div>
        </div>

        <!-- Today & Month Stats -->
        <div class="stats-grid" style="margin-bottom: 30px;">
            <div class="content-section">
                <h3 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 700; color: #212529;">Today's Activity</h3>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span style="color: #6c757d; font-weight: 500;">Bookings:</span>
                        <strong style="color: #0070f3; font-size: 1.1rem;" id="todayBookings">0</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span style="color: #6c757d; font-weight: 500;">Revenue:</span>
                        <strong style="color: #28a745; font-size: 1.1rem;">‚Ç±<span id="todayRevenue">0</span></strong>
                </div>
                </div>
            </div>
            <div class="content-section">
                <h3 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 700; color: #212529;">This Month</h3>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span style="color: #6c757d; font-weight: 500;">Bookings:</span>
                        <strong style="color: #0070f3; font-size: 1.1rem;" id="monthBookings">0</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span style="color: #6c757d; font-weight: 500;">Revenue:</span>
                        <strong style="color: #28a745; font-size: 1.1rem;">‚Ç±<span id="monthRevenue">0</span></strong>
                </div>
                </div>
            </div>
            <div class="content-section">
                <h3 style="margin: 0 0 20px 0; font-size: 1.25rem; font-weight: 700; color: #212529;">Bookings Status</h3>
                <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span style="color: #6c757d; font-weight: 500;">Completed:</span>
                        <strong style="color: #28a745; font-size: 1.1rem;" id="completedBookings">0</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span style="color: #6c757d; font-weight: 500;">Pending:</span>
                        <strong style="color: #ffc107; font-size: 1.1rem;" id="pendingBookings">0</strong>
                </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                        <span style="color: #6c757d; font-weight: 500;">Accepted:</span>
                        <strong style="color: #17a2b8; font-size: 1.1rem;" id="acceptedBookings">0</strong>
                </div>
                </div>
            </div>
        </div>

        <!-- Account Deletion Requests -->
        <div class="content-section" style="margin-top: 30px; border-left: 4px solid #ffc107;">
            <div class="section-header">
                <h2 style="margin: 0; color: #212529;">‚ö†Ô∏è Account Deletion Requests</h2>
                <button class="btn btn-outline" onclick="loadDeletionRequests()" style="padding: 10px 16px; font-size: 0.9rem;">
                    üîÑ Refresh
                </button>
            </div>
            <div id="deletionRequestsSection">
                <p style="text-align: center; color: #6c757d; padding: 40px;">Loading deletion requests...</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="stats-grid" style="margin-top: 30px;">
            <div class="service-card" style="cursor: pointer;" onclick="window.location.href='/admin/provider-verification'">
                <h3 style="margin: 0 0 12px 0; color: #212529; font-size: 1.25rem; font-weight: 600;">Provider Verification</h3>
                <p class="service-info">Review and verify service provider applications. <strong style="color: #ffc107;"><span id="pendingProviders">0</span> pending verification</strong>.</p>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="event.stopPropagation(); window.location.href='/admin/provider-verification';">
                    Go to Provider Verification
                </button>
            </div>

            <div class="service-card" style="cursor: pointer;" onclick="window.location.href='/admin/dispute-management'">
                <h3 style="margin: 0 0 12px 0; color: #212529; font-size: 1.25rem; font-weight: 600;">Dispute Management</h3>
                <p class="service-info">Handle customer-provider disputes, resolve conflicts, and ensure fair resolution for all parties involved.</p>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="event.stopPropagation(); window.location.href='/admin/dispute-management';">
                    Go to Dispute Management
                </button>
            </div>

            <div class="service-card" style="cursor: pointer;" onclick="window.location.href='/admin/reports'">
                <h3 style="margin: 0 0 12px 0; color: #212529; font-size: 1.25rem; font-weight: 600;">Reports & Analytics</h3>
                <p class="service-info">Generate detailed reports on bookings, providers, customers, and earnings.</p>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="event.stopPropagation(); window.location.href='/admin/reports';">
                    Go to Reports
                </button>
            </div>
        </div>
    </main>
</div>

<script>
async function loadAdminData() {
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('No token found');
        return;
    }

    try {
        // Load dashboard statistics
        const statsResponse = await fetch('/api/admin/dashboard/stats', {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (statsResponse.ok) {
            const stats = await statsResponse.json();
            document.getElementById('totalBookings').textContent = stats.total_bookings || 0;
            document.getElementById('totalRevenue').textContent = (stats.total_revenue || 0).toLocaleString();
            document.getElementById('activeProviders').textContent = stats.active_providers || 0;
            document.getElementById('totalCustomers').textContent = stats.total_customers || 0;
            document.getElementById('openDisputes').textContent = stats.open_disputes || 0;
            document.getElementById('avgRating').textContent = (stats.average_rating || 0).toFixed(1);
            document.getElementById('todayBookings').textContent = stats.today_bookings || 0;
            document.getElementById('todayRevenue').textContent = (stats.today_revenue || 0).toLocaleString();
            document.getElementById('monthBookings').textContent = stats.month_bookings || 0;
            document.getElementById('monthRevenue').textContent = (stats.month_revenue || 0).toLocaleString();
            document.getElementById('completedBookings').textContent = stats.bookings_by_status?.completed || 0;
            document.getElementById('pendingBookings').textContent = stats.bookings_by_status?.pending || 0;
            document.getElementById('acceptedBookings').textContent = stats.bookings_by_status?.accepted || 0;
            document.getElementById('pendingProviders').textContent = stats.pending_providers || 0;
        } else {
            console.error('Failed to load stats:', statsResponse.status);
            // Set defaults on error
            document.getElementById('totalBookings').textContent = '0';
            document.getElementById('activeProviders').textContent = '0';
            document.getElementById('totalCustomers').textContent = '0';
            document.getElementById('openDisputes').textContent = '0';
        }
    } catch (error) {
        console.error('Error loading admin data:', error);
        // Set defaults on error
        document.getElementById('totalBookings').textContent = '0';
        document.getElementById('activeProviders').textContent = '0';
        document.getElementById('totalCustomers').textContent = '0';
        document.getElementById('openDisputes').textContent = '0';
    }
}

// Load admin profile - more robust version
function loadAdminProfile() {
    try {
        const userStr = localStorage.getItem('user');
        if (!userStr) return;
        
        const user = JSON.parse(userStr);
        const nameElement = document.getElementById('adminName');
        const pictureElement = document.getElementById('adminProfilePicture');
        
        if (nameElement) {
            if (user.fullName) {
                nameElement.textContent = user.fullName;
            } else {
                nameElement.textContent = 'Admin';
            }
        }
        
        if (pictureElement) {
            if (user.profile_picture) {
                // Ensure the image loads properly
                const img = new Image();
                img.onload = () => {
                    pictureElement.src = user.profile_picture;
                };
                img.onerror = () => {
                    pictureElement.src = '{{ url_for("static", filename="images/placeholder-user.jpg") }}';
                };
                img.src = user.profile_picture;
            } else {
                pictureElement.src = '{{ url_for("static", filename="images/placeholder-user.jpg") }}';
            }
        }
    } catch (e) {
        console.error('Error loading admin profile:', e);
    }
}

// Reload profile picture when navigating
function refreshAdminProfile() {
    loadAdminProfile();
}

// Store original image src to prevent loss
let adminProfilePictureSrc = null;
function preserveAdminProfilePicture() {
    const pictureElement = document.getElementById('adminProfilePicture');
    if (pictureElement && pictureElement.src) {
        adminProfilePictureSrc = pictureElement.src;
    }
}

// Restore profile picture if it gets lost
function restoreAdminProfilePicture() {
    const pictureElement = document.getElementById('adminProfilePicture');
    if (pictureElement) {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.profile_picture) {
            pictureElement.src = user.profile_picture;
        } else if (adminProfilePictureSrc) {
            pictureElement.src = adminProfilePictureSrc;
        }
    }
}

// Load notifications
async function loadNotifications() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/notifications', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const data = await response.json();
            displayNotifications(data.notifications || []);
            updateNotificationBadge(data.unread_count || 0);
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function displayNotifications(notifications) {
    const container = document.getElementById('notificationsList');
    if (!notifications || notifications.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No notifications</p>';
        return;
    }
    
    let html = '';
    notifications.slice(0, 20).forEach(notif => {
        const date = new Date(notif.created_at);
        const typeColors = {
            'info': '#0070f3',
            'success': '#28a745',
            'warning': '#ffc107',
            'error': '#dc3545'
        };
        const bgColor = notif.read ? '#f8f9fa' : '#e3f2fd';
        
        html += `
            <div onclick="markNotificationRead('${notif._id}')" 
                 style="padding: 12px; border-bottom: 1px solid #e0e0e0; cursor: pointer; background: ${bgColor}; transition: background 0.2s;"
                 onmouseover="this.style.background='#f0f0f0'" 
                 onmouseout="this.style.background='${bgColor}'">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                    <div style="flex: 1;">
                        <strong style="color: ${typeColors[notif.type] || '#212529'}; display: block; margin-bottom: 4px;">${notif.title}</strong>
                        <p style="margin: 0; color: #6c757d; font-size: 0.9rem; line-height: 1.4;">${notif.message}</p>
                        <small style="color: #999; font-size: 0.75rem; display: block; margin-top: 6px;">${date.toLocaleString()}</small>
                    </div>
                    ${!notif.read ? '<span style="width: 8px; height: 8px; background: #0070f3; border-radius: 50%; flex-shrink: 0; margin-top: 4px;"></span>' : ''}
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

function updateNotificationBadge(count) {
    const badge = document.getElementById('notificationBadge');
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

function toggleNotifications() {
    const dropdown = document.getElementById('notificationsDropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    if (dropdown.style.display === 'block') {
        loadNotifications();
    }
}

async function markNotificationRead(notificationId) {
    const token = localStorage.getItem('token');
    try {
        await fetch(`/api/notifications/${notificationId}/read`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadNotifications();
    } catch (error) {
        console.error('Error marking notification as read:', error);
    }
}

async function markAllNotificationsRead() {
    const token = localStorage.getItem('token');
    try {
        await fetch('/api/notifications/read-all', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        loadNotifications();
    } catch (error) {
        console.error('Error marking all as read:', error);
    }
}

function showAdminProfileModal() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    document.getElementById('adminProfileFullName').value = user.fullName || '';
    document.getElementById('adminProfileEmail').value = user.email || '';
    document.getElementById('adminProfilePhone').value = user.phone || '';
    document.getElementById('adminProfilePassword').value = '';
    
    const profilePic = user.profile_picture || '{{ url_for("static", filename="images/placeholder-user.jpg") }}';
    document.getElementById('adminModalProfilePicture').src = profilePic;
    document.getElementById('adminProfileModal').style.display = 'block';
}

function closeAdminProfileModal() {
    document.getElementById('adminProfileModal').style.display = 'none';
}

async function saveAdminProfile() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/update-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                fullName: document.getElementById('adminProfileFullName').value,
                email: document.getElementById('adminProfileEmail').value,
                phone: document.getElementById('adminProfilePhone').value,
                password: document.getElementById('adminProfilePassword').value || undefined
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.user) {
                localStorage.setItem('user', JSON.stringify(result.user));
                loadAdminProfile();
                preserveAdminProfilePicture();
            }
            alert('Profile updated successfully!');
            closeAdminProfileModal();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to update profile'));
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Network error. Please try again.');
    }
}

async function handleAdminProfilePictureUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
    }
    
    if (file.size > 5 * 1024 * 1024) {
        alert('Image size must be less than 5MB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        document.getElementById('adminModalProfilePicture').src = e.target.result;
        document.getElementById('adminProfilePicture').src = e.target.result;
    };
    reader.readAsDataURL(file);
    
    const formData = new FormData();
    formData.append('profile_picture', file);
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch('/api/update-profile', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            },
            body: formData
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.user) {
                localStorage.setItem('user', JSON.stringify(result.user));
                if (result.user.profile_picture) {
                    document.getElementById('adminProfilePicture').src = result.user.profile_picture;
                    preserveAdminProfilePicture();
                }
                alert('Profile picture uploaded successfully!');
            }
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to upload profile picture'));
        }
    } catch (error) {
        console.error('Error uploading profile picture:', error);
    }
}

// Load account deletion requests
async function loadDeletionRequests() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/admin/accounts/deletion-requests', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const requests = await response.json();
            displayDeletionRequests(requests);
        }
    } catch (error) {
        console.error('Error loading deletion requests:', error);
    }
}

function displayDeletionRequests(requests) {
    const container = document.getElementById('deletionRequestsSection');
    if (!container) return;
    
    if (!requests || requests.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 20px;">No pending deletion requests</p>';
        return;
    }
    
    let html = '<div style="display: grid; gap: 15px;">';
    requests.forEach(req => {
        const date = new Date(req.deletion_requested_at);
        html += `
            <div class="booking-card-detailed" style="border-left: 4px solid #ffc107;">
                <div class="booking-header-detailed">
                    <h3 class="booking-title-detailed">${req.fullName || req.username || 'User'} (${req.role})</h3>
                    <span class="status-badge" style="background: #ffc107; color: #212529;">Pending Approval</span>
                </div>
                <div class="booking-info-grid">
                    <div class="info-item">
                        <strong>Email:</strong>
                        <span>${req.email || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <strong>Phone:</strong>
                        <span>${req.phone || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <strong>Requested:</strong>
                        <span>${date.toLocaleString()}</span>
                    </div>
                    <div class="info-item" style="grid-column: 1 / -1;">
                        <strong>Reason:</strong>
                        <span>${req.deletion_reason || 'No reason provided'}</span>
                    </div>
                </div>
                <div class="booking-actions">
                    <button onclick="approveDeletion('${req._id}', '${(req.fullName || req.username || 'User').replace(/'/g, "\\'")}')" 
                            class="btn btn-outline" style="background: #dc3545; color: white; border-color: #dc3545;">
                        Approve Deletion
                    </button>
                    <button onclick="rejectDeletion('${req._id}', '${(req.fullName || req.username || 'User').replace(/'/g, "\\'")}')" 
                            class="btn btn-outline" style="background: #28a745; color: white; border-color: #28a745;">
                        Reject & Enable
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    container.innerHTML = html;
}

async function approveDeletion(userId, userName) {
    if (!confirm(`Are you sure you want to permanently delete "${userName}"? This cannot be undone.`)) {
        return;
    }
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/admin/accounts/${userId}/approve-deletion`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            alert('Account deleted successfully');
            loadDeletionRequests();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to delete account'));
        }
    } catch (error) {
        console.error('Error approving deletion:', error);
        alert('Network error. Please try again.');
    }
}

async function rejectDeletion(userId, userName) {
    const reason = prompt(`Enter reason for rejecting deletion request (optional):`) || 'Deletion request rejected by admin';
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/admin/accounts/${userId}/reject-deletion`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ reason })
        });
        
        if (response.ok) {
            alert('Deletion request rejected. Account has been re-enabled.');
            loadDeletionRequests();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to reject deletion'));
        }
    } catch (error) {
        console.error('Error rejecting deletion:', error);
        alert('Network error. Please try again.');
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const adminModal = document.getElementById('adminProfileModal');
    const notificationsDropdown = document.getElementById('notificationsDropdown');
    if (event.target == adminModal) {
        closeAdminProfileModal();
    }
    if (!event.target.closest('#notificationBell') && !event.target.closest('#notificationsDropdown')) {
        notificationsDropdown.style.display = 'none';
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadAdminData();
    loadAdminProfile();
    loadNotifications();
    loadDeletionRequests();
    preserveAdminProfilePicture();
    
    // Refresh notifications every 30 seconds
    setInterval(loadNotifications, 30000);
    // Refresh profile picture periodically to ensure it persists
    setInterval(() => {
        restoreAdminProfilePicture();
        loadAdminProfile();
    }, 1000);
});

// Also reload profile when page becomes visible (user switches tabs/windows)
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        loadAdminProfile();
        preserveAdminProfilePicture();
    }
});

// Monitor for image src changes and restore if needed
const adminPictureObserver = new MutationObserver(() => {
    const pictureElement = document.getElementById('adminProfilePicture');
    if (pictureElement) {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.profile_picture && !pictureElement.src.includes(user.profile_picture.split(',')[0])) {
            pictureElement.src = user.profile_picture;
        }
    }
});

// Start observing when page loads
setTimeout(() => {
    const pictureElement = document.getElementById('adminProfilePicture');
    if (pictureElement) {
        adminPictureObserver.observe(pictureElement, { attributes: true, attributeFilter: ['src'] });
    }
}, 500);
</script>

<!-- Admin Profile Modal -->
<div id="adminProfileModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: #212529;">Admin Profile Settings</h2>
            <span onclick="closeAdminProfileModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
        </div>
        <div style="padding: 30px;">
            <div style="text-align: center; margin-bottom: 30px;">
                <img id="adminModalProfilePicture" src="{{ url_for('static', filename='images/placeholder-user.jpg') }}" 
                     alt="Profile Picture" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #0070f3; cursor: pointer; margin-bottom: 15px;" 
                     onclick="document.getElementById('adminProfilePictureInput').click()">
                <input type="file" id="adminProfilePictureInput" accept="image/*" style="display: none;" onchange="handleAdminProfilePictureUpload(event)">
                <p style="margin: 10px 0 0 0; color: #6c757d; font-size: 0.9rem;">Click to upload profile picture</p>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Full Name</label>
                <input type="text" id="adminProfileFullName" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Email</label>
                <input type="email" id="adminProfileEmail" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Phone Number</label>
                <input type="tel" id="adminProfilePhone" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Change Password</label>
                <input type="password" id="adminProfilePassword" placeholder="Leave blank to keep current password" style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 15px; box-sizing: border-box;">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px; border-top: 1px solid #e0e0e0; padding-top: 20px;">
                <button onclick="closeAdminProfileModal()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">
                    Cancel
                </button>
                <button onclick="saveAdminProfile()" style="background: #0070f3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}
