{% extends "base.html" %}

{% block title %}Forgot Password - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
{% endblock %}

{% block content %}
<div class="desktop">
    <div class="image-container">
        <img class="image" src="{{ url_for('static', filename='images/logo.png') }}" alt="AyudaBesh Logo" width="200" height="200">
    </div>

    <div class="login-container">
        <form class="login-form" id="forgotPasswordForm" onsubmit="return false;">
            <h2>Reset Your Password</h2>
            <p style="color: #6c757d; margin-bottom: 24px; text-align: center; line-height: 1.6;">Enter your email or phone number to receive a verification code. We'll send it to you via email or SMS.</p>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" style="display: none; background: #d4edda; color: #155724; border-left: 4px solid #28a745; padding: 14px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);"></div>

            <div class="input-group">
                <label for="identifier">Email or Phone Number</label>
                <input
                    type="text"
                    id="identifier"
                    name="identifier"
                    placeholder="e.g., user@example.com or +63 912 345 6789"
                    required
                    autocomplete="email"
                />
                <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">We'll send a verification code to this email or phone number</small>
            </div>

            <div class="input-group">
                <label for="role" style="margin-bottom: 12px;">Account Type</label>
                <div class="role-selector">
                    <label>
                        <input type="radio" name="role" value="customer" checked />
                        Customer
                    </label>
                    <label>
                        <input type="radio" name="role" value="provider" />
                        Provider
                    </label>
                    <label>
                        <input type="radio" name="role" value="admin" />
                        Admin
                    </label>
                </div>
            </div>

            <button type="submit" class="login-button" id="submitButton">
                Send Verification Code
            </button>

            <div class="links" style="margin-top: 20px;">
                <a href="{{ url_for('frontend.login') }}">‚Üê Back to Login</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const errorDiv = document.getElementById('errorMessage');
    const successDiv = document.getElementById('successMessage');
    const submitButton = document.getElementById('submitButton');
    const identifier = document.getElementById('identifier').value.trim();
    const role = document.querySelector('input[name="role"]:checked').value;
    
    // Reset messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    if (!identifier) {
        errorDiv.textContent = 'Please enter your email or phone number';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Disable button
    submitButton.disabled = true;
    submitButton.textContent = 'Sending...';
    
    try {
        const response = await fetch('/api/auth/forgot-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                identifier: identifier,
                role: role
            })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            errorDiv.textContent = data.error || 'Failed to send verification code';
            errorDiv.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = 'Send Verification Code';
            return;
        }
        
        // Success - show message
        let message = '<strong style="font-size: 16px;">Verification code sent successfully!</strong><br><br>';
        
        if (data.sent_via && data.sent_via.length > 0) {
            const sentViaText = data.sent_via.map(method => method.toUpperCase()).join(' and ');
            message += `The verification code has been sent to you via <strong>${sentViaText}</strong>.<br><br>`;
        }
        
        if (data.verification_code) {
            // Email/SMS not configured - show code for development
            message += `<div style="background: #fff3cd; border: 2px solid #ffc107; padding: 12px; border-radius: 6px; margin: 12px 0;">`;
            message += `<strong>Development Mode:</strong><br>`;
            message += `Your verification code is: <strong style="font-size: 20px; color: #0070f3; letter-spacing: 3px;">${data.verification_code}</strong><br>`;
            message += `<small style="color: #856404;">(In production, this would only be sent via email/SMS)</small>`;
            message += `</div>`;
        } else {
            message += 'Please check your email or phone for the verification code.';
        }
        
        message += '<br><small style="color: #6c757d;">Redirecting to reset password page...</small>';
        
        successDiv.innerHTML = message;
        successDiv.style.display = 'block';
        
        // Store reset token for next step
        if (data.reset_token) {
            localStorage.setItem('password_reset_token', data.reset_token);
        }
        
        // Redirect to reset password page after 3 seconds
        setTimeout(() => {
            window.location.href = '/reset-password?token=' + (data.reset_token || '');
        }, 3000);
        
    } catch (err) {
        errorDiv.textContent = 'Network error: ' + (err.message || 'Please try again');
        errorDiv.style.display = 'block';
        submitButton.disabled = false;
        submitButton.textContent = 'Send Verification Code';
    }
});
</script>
{% endblock %}
