<!-- templates/customer/book_service.html -->
{% extends "base.html" %}

{% block title %}Book Service - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer_dashboard.css') }}">
<style>
.book-service-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 30px 20px;
    background: #f8f9fa;
    min-height: calc(100vh - 60px);
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 20px;
}

.page-header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 700;
    color: #212529;
    letter-spacing: -0.02em;
}

.service-selection-section {
    background: white;
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 24px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #495057;
    font-weight: 600;
    font-size: 0.95rem;
}

.form-group select,
.form-group input,
.form-group textarea {
    width: 100%;
    padding: 14px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s ease;
    box-sizing: border-box;
    background: #f8f9fa;
    font-family: inherit;
}

.form-group select:focus,
.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #0070f3;
    background: white;
    box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1);
}

.form-group textarea {
    resize: vertical;
    min-height: 100px;
}

.providers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
    margin-top: 30px;
}

.booking-form-section {
    background: white;
    padding: 35px;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    margin-top: 30px;
}

.booking-summary {
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #28a745;
    margin-bottom: 25px;
}

.booking-summary h4 {
    margin: 0 0 12px 0;
    color: #155724;
    font-size: 1.1rem;
}

.price-display {
    font-size: 2rem;
    font-weight: 700;
    color: #0070f3;
    margin: 8px 0;
}

.price-note {
    color: #6c757d;
    font-size: 0.85rem;
    margin-top: 8px;
}

.info-box {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
}

.info-box p {
    margin: 0;
    color: #495057;
    font-size: 0.95rem;
}

.info-box strong {
    color: #212529;
}
</style>
{% endblock %}

{% block content %}
<div class="book-service-container">
    <div class="page-header">
        <h1>Book a Service</h1>
        <button class="btn btn-outline" onclick="window.location.href='/customer/dashboard'">
            ‚Üê Back to Dashboard
        </button>
    </div>
    
    <!-- Service Selection Section -->
    <div class="service-selection-section">
        <h2 style="margin: 0 0 25px 0; font-size: 1.5rem; font-weight: 700; color: #212529;">Select Service Type</h2>
        <div class="form-group">
            <label for="serviceType">Choose a Service Category <span style="color: #dc3545;">*</span></label>
            <select id="serviceType" required>
                <option value="">-- Select a service type --</option>
            <option value="cleaning">Domestic Cleaning</option>
            <option value="plumbing">Plumbing</option>
            <option value="electrical">Electrical Work</option>
            <option value="pest_control">Pest Control</option>
            <option value="appliance">Appliance Installation</option>
            <option value="maintenance">General Maintenance</option>
            <option value="online_services">Online Services</option>
        </select>
    </div>
    
        <div id="providersList">
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <p style="font-size: 1.1rem; margin: 0;">Select a service type to see available providers</p>
            </div>
        </div>
    </div>
    
    <!-- Booking Form Section -->
    <div id="bookingForm" class="booking-form-section" style="display: none;">
        <h2 style="margin: 0 0 30px 0; font-size: 1.5rem; font-weight: 700; color: #212529;">Step 2: Booking Details</h2>
        
        <input type="hidden" id="selectedProviderId">
        <input type="hidden" id="selectedService">
        <input type="hidden" id="selectedProviderName">
        
        <!-- Selected Provider Summary -->
        <div class="info-box">
            <p><strong>Service Provider:</strong> <span id="selectedProviderDisplay"></span></p>
            <p style="margin-top: 8px;"><strong>Service Type:</strong> <span id="selectedServiceDisplay"></span></p>
        </div>
        
        <div class="form-group">
            <label for="bookingTime">Preferred Date & Time <span style="color: #dc3545;">*</span></label>
            <input type="datetime-local" id="bookingTime" required>
            <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Select when you'd like the service to be performed</small>
        </div>
        
        <div class="form-group">
            <label for="serviceAddress">Service Address <span style="color: #dc3545;">*</span></label>
            <input type="text" id="serviceAddress" placeholder="Enter the complete address where service will be performed" required>
            <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Include street, barangay, city for accurate location</small>
        </div>
        
        <div class="form-group">
            <label for="contactPhone">Contact Phone Number <span style="color: #dc3545;">*</span></label>
            <input type="tel" id="contactPhone" placeholder="e.g., +63 912 345 6789" required>
            <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Provider will contact you at this number</small>
        </div>
        
        <div class="form-group">
            <label for="specialInstructions">Special Instructions or Notes</label>
            <textarea id="specialInstructions" rows="4" placeholder="Any special requirements, access instructions, or details the provider should know..."></textarea>
            <small style="display: block; margin-top: 6px; color: #6c757d; font-size: 0.85rem;">Optional: Add any specific requirements or instructions</small>
        </div>
        
        <!-- Price Summary -->
        <div class="booking-summary">
            <h4>Estimated Price</h4>
            <div class="price-display">‚Ç±<span id="bookingPrice">0</span>/hr</div>
            <p class="price-note">Final price may vary based on service requirements and duration. The provider will confirm the final price after reviewing your request.</p>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 30px;">
            <button onclick="document.getElementById('bookingForm').style.display='none'; window.scrollTo({top: 0, behavior: 'smooth'});" 
                    class="btn btn-outline" style="flex: 1;">
                ‚Üê Change Provider
            </button>
            <button onclick="confirmBooking()" class="btn btn-primary" style="flex: 2; padding: 14px 24px; font-size: 1rem;">
                Confirm Booking
            </button>
        </div>
    </div>
</div>

<script>
let selectedProvider = null;

async function loadProviders() {
    const service = document.getElementById('serviceType').value;
    if (!service) {
        document.getElementById('providersList').innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                <p style="font-size: 1.1rem; margin: 0;">Select a service type to see available providers</p>
            </div>
        `;
        return;
    }
    
    // Show loading state
    document.getElementById('providersList').innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
            <p style="font-size: 1.1rem; margin: 0;">Loading providers...</p>
        </div>
    `;
    
    try {
        // Get token from localStorage
        const token = localStorage.getItem('token');
        const headers = token ? {'Authorization': `Bearer ${token}`} : {};
        
        const response = await fetch(`/api/providers?service=${service}&verified=true`, {headers});
        
        if (!response.ok) {
            throw new Error('Failed to load providers');
        }
        
        const providers = await response.json();
        
        if (!providers || providers.length === 0) {
            document.getElementById('providersList').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <p style="font-size: 1.1rem; margin-bottom: 10px;">No verified providers available for this service</p>
                    <p style="margin: 0;">Please try selecting a different service type</p>
                </div>
            `;
            return;
        }
        
        if (providers.length === 0) {
            document.getElementById('providersList').innerHTML = `
                <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                    <p style="font-size: 1.1rem; margin-bottom: 10px;">No verified providers available for this service</p>
                    <p style="margin: 0;">Please try selecting a different service type</p>
                </div>
            `;
            return;
        }
        
        let html = '<h3 style="margin: 0 0 25px 0; font-size: 1.25rem; font-weight: 600; color: #212529;">Available Verified Providers:</h3>';
        html += '<div class="providers-grid">';
        
        providers.forEach(provider => {
            const verifiedBadge = provider.is_verified 
                ? '<span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">‚úì Verified</span>' 
                : '';
            const rating = provider.rating || 0;
            const ratingDisplay = rating > 0 
                ? `<span class="rating-display">${'‚≠ê'.repeat(Math.floor(rating))} ${rating.toFixed(1)}/5</span>` 
                : '<span style="color: #6c757d; font-size: 0.85rem;">New Provider</span>';
            
            html += `
                <div class="service-card" onclick="selectProvider('${provider._id || provider.id}', '${(provider.username || provider.fullName || 'Provider').replace(/'/g, "\\'")}', ${provider.hourly_rate || 500}, '${(provider.location || 'Location not specified').replace(/'/g, "\\'")}', ${rating})" style="cursor: pointer;">
                    <div style="flex-grow: 1;">
                        <h3 style="margin: 0 0 10px 0; color: #212529; font-size: 1.25rem; font-weight: 600; line-height: 1.4;">
                            ${provider.username || provider.fullName || 'Provider'}${verifiedBadge}
                        </h3>
                        <p class="service-type">${service.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                        ${provider.description ? `
                            <p class="service-info" style="margin: 12px 0;">
                                ${provider.description.length > 100 ? provider.description.substring(0, 100) + '...' : provider.description}
                            </p>
                        ` : ''}
                        <div class="service-meta">
                            <span>üìç ${provider.location || 'Location not specified'}</span>
                            <span>${ratingDisplay}</span>
                        </div>
                        <div class="service-price">‚Ç±${provider.hourly_rate || 500}/hr</div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="event.stopPropagation(); selectProvider('${provider._id || provider.id}', '${(provider.username || provider.fullName || 'Provider').replace(/'/g, "\\'")}', ${provider.hourly_rate || 500}, '${(provider.location || 'Location not specified').replace(/'/g, "\\'")}', ${rating});">
                        Select Provider
                    </button>
                </div>
            `;
        });
        
        html += '</div>';
        document.getElementById('providersList').innerHTML = html;
        
        // Auto-select provider if coming from dashboard
        if (prefillBookingInfo && prefillBookingInfo.provider_id) {
            setTimeout(() => {
                const providerElements = document.querySelectorAll('[onclick*="selectProvider"]');
                providerElements.forEach(element => {
                    const onclickAttr = element.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(prefillBookingInfo.provider_id)) {
                        // Extract provider info from the onclick attribute
                        const match = onclickAttr.match(/selectProvider\('([^']+)',\s*'([^']+)',\s*(\d+)\)/);
                        if (match && match[1] === prefillBookingInfo.provider_id) {
                            selectProvider(match[1], match[2], parseInt(match[3]));
                            prefillBookingInfo = null; // Clear after use
                        }
                    }
                });
            }, 300); // Wait for DOM to update
        }
    } catch (error) {
        console.error('Error loading providers:', error);
        document.getElementById('providersList').innerHTML = '<p>Failed to load providers. Please try again.</p>';
    }
}

function selectProvider(providerId, fullName, price, location, rating) {
    selectedProvider = { 
        id: providerId, 
        name: fullName, 
        price: price,
        location: location || 'Location not specified',
        rating: rating || 0
    };
    document.getElementById('selectedProviderId').value = providerId;
    document.getElementById('selectedProviderName').value = fullName;
    const serviceType = document.getElementById('serviceType').value;
    document.getElementById('selectedService').value = serviceType;
    
    // Display selected provider and service
    document.getElementById('selectedProviderDisplay').textContent = fullName;
    document.getElementById('selectedServiceDisplay').textContent = serviceType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
    document.getElementById('bookingPrice').textContent = price.toLocaleString();
    document.getElementById('bookingForm').style.display = 'block';
    
    // Scroll to booking form
    setTimeout(() => {
        document.getElementById('bookingForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}

async function confirmBooking() {
    const bookingTime = document.getElementById('bookingTime').value;
    const serviceAddress = document.getElementById('serviceAddress').value.trim();
    const contactPhone = document.getElementById('contactPhone').value.trim();
    const specialInstructions = document.getElementById('specialInstructions').value.trim();
    
    // Validation
    if (!bookingTime) {
        alert('Please select a booking date and time');
        document.getElementById('bookingTime').focus();
        return;
    }
    
    // Check if selected time is in the future
    const selectedDate = new Date(bookingTime);
    if (selectedDate < new Date()) {
        alert('Please select a future date and time');
        document.getElementById('bookingTime').focus();
        return;
    }
    
    if (!serviceAddress) {
        alert('Please enter the service address');
        document.getElementById('serviceAddress').focus();
        return;
    }
    
    if (!contactPhone) {
        alert('Please enter your contact phone number');
        document.getElementById('contactPhone').focus();
        return;
    }
    
    // Basic phone validation
    const phoneRegex = /^[\d\s\-\+\(\)]+$/;
    if (!phoneRegex.test(contactPhone) || contactPhone.replace(/\D/g, '').length < 10) {
        alert('Please enter a valid phone number');
        document.getElementById('contactPhone').focus();
        return;
    }
    
    if (!selectedProvider || !selectedProvider.id) {
        alert('Please select a provider first');
        return;
    }
    
    const user = JSON.parse(localStorage.getItem('user'));
    const token = localStorage.getItem('token');
    
    if (!user || !token) {
        alert('Please log in first');
        window.location.href = '/login';
        return;
    }
    
    // Disable button and show loading
    const confirmBtn = event.target;
    const originalText = confirmBtn.textContent;
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Processing...';
    
    try {
        // Convert datetime-local to ISO format
        const isoDateTime = new Date(bookingTime).toISOString();
        
        const response = await fetch('/api/book', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                customer_id: user.id,
                customer_name: user.fullName,
                customer_email: user.email,
                customer_phone: contactPhone,
                provider_id: selectedProvider.id,
                service_type: document.getElementById('selectedService').value,
                booking_time: isoDateTime,
                service_address: serviceAddress,
                special_instructions: specialInstructions,
                price: selectedProvider.price
            })
        });
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response received:', text.substring(0, 200));
            console.error('Response status:', response.status);
            console.error('Response headers:', Object.fromEntries(response.headers.entries()));
            alert('‚ùå Server error: Received non-JSON response. Status: ' + response.status + '. Please check the console for details.');
            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
            return;
        }
        
        const result = await response.json();
        if (response.ok) {
            // Show success message
            alert('‚úÖ Booking confirmed! Your provider will be notified and will contact you soon.');
            // Redirect to dashboard
            window.location.href = '/customer/dashboard';
        } else {
            const errorMsg = result.error || 'Booking failed. Please try again.';
            alert('‚ùå Booking failed: ' + errorMsg);
            confirmBtn.disabled = false;
            confirmBtn.textContent = originalText;
            if (errorMsg.includes('Token') || errorMsg.includes('unauthorized')) {
                setTimeout(() => {
                window.location.href = '/login';
                }, 2000);
            }
        }
    } catch (error) {
        console.error('Booking error:', error);
        console.error('Error details:', {
            message: error.message,
            stack: error.stack,
            name: error.name
        });
        alert('‚ùå Error: ' + (error.message || 'Network error. Please check your connection and try again.'));
        confirmBtn.disabled = false;
        confirmBtn.textContent = originalText;
    }
}

// Store prefill booking info globally for use after providers load
let prefillBookingInfo = null;

// Check for prefill booking info from dashboard
document.addEventListener('DOMContentLoaded', () => {
    const prefillBooking = sessionStorage.getItem('prefillBooking');
    if (prefillBooking) {
        try {
            prefillBookingInfo = JSON.parse(prefillBooking);
            document.getElementById('serviceType').value = prefillBookingInfo.service_type;
            sessionStorage.removeItem('prefillBooking'); // Clear after use
            // Load providers for the selected service
            loadProviders();
        } catch (error) {
            console.error('Error parsing prefill booking:', error);
        }
    }
});

// Initialize
document.getElementById('serviceType').addEventListener('change', loadProviders);
</script>
{% endblock %}