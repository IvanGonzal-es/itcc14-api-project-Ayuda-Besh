<!-- templates/admin/reports.html -->
{% extends "base.html" %}

{% block title %}Reports - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="customer-dashboard">
    <div class="dashboard-header">
        <h1>Reports & Analytics</h1>
        <button class="btn btn-outline" onclick="window.location.href='/admin/dashboard'">
            ← Back to Dashboard
        </button>
    </div>

    <!-- Report Filters -->
    <div class="content-section">
        <div class="section-header">
            <h2>Generate Report</h2>
        </div>
        <div class="filter-section">
            <div class="filter-group" style="flex-wrap: wrap; align-items: end;">
            <div>
                    <label for="reportType" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Report Type</label>
                    <select id="reportType" style="min-width: 200px;">
                    <option value="daily">Daily Bookings</option>
                    <option value="provider">Provider Activity</option>
                    <option value="customer">Customer History</option>
                    <option value="earnings">Provider Earnings</option>
                </select>
            </div>
                <div id="dateFilter">
                    <label for="reportDate" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Date</label>
                    <input type="date" id="reportDate">
            </div>
                <div id="dateRangeFilter" style="display: none; gap: 15px;">
                <div>
                        <label for="startDate" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">Start Date</label>
                        <input type="date" id="startDate">
                </div>
                <div>
                        <label for="endDate" style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">End Date</label>
                        <input type="date" id="endDate">
                    </div>
                </div>
                <button onclick="generateReport()" class="btn btn-primary" style="padding: 10px 20px; font-size: 0.9rem;">
                    Generate Report
                </button>
                <button onclick="exportReport()" class="btn btn-secondary" style="padding: 10px 20px; font-size: 0.9rem;">
                    Export CSV
                </button>
            </div>
        </div>
    </div>

    <!-- Report Results -->
    <div class="content-section" id="reportResults">
        <div id="loadingMessage" style="text-align: center; padding: 60px 20px; color: #6c757d;">
            <p style="font-size: 1.1rem; margin: 0;">Select a report type and click "Generate Report" to view data.</p>
        </div>
        <div id="reportContent" style="display: none;">
            <div class="section-header">
                <h2 id="reportTitle"></h2>
            </div>
            <div id="reportTable" style="overflow-x: auto; margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Report Summary -->
    <div id="reportSummary" class="stats-grid" style="margin-top: 30px; display: none;">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<script>
let currentReportData = null;

document.getElementById('reportType').addEventListener('change', function() {
    const reportType = this.value;
    const dateFilter = document.getElementById('dateFilter');
    const dateRangeFilter = document.getElementById('dateRangeFilter');
    
    if (reportType === 'daily') {
        dateFilter.style.display = 'block';
        dateRangeFilter.style.display = 'none';
    } else {
        dateFilter.style.display = 'none';
        dateRangeFilter.style.display = 'flex';
        dateRangeFilter.style.alignItems = 'end';
    }
});

async function generateReport() {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('Please log in first');
        return;
    }
    
    const reportType = document.getElementById('reportType').value;
    let url = '';
    let params = new URLSearchParams();
    
    // Build API URL based on report type
    switch(reportType) {
        case 'daily':
            const date = document.getElementById('reportDate').value;
            if (!date) {
                alert('Please select a date');
                return;
            }
            url = `/api/admin/reports/daily-bookings?date=${date}`;
            break;
        case 'provider':
            url = '/api/admin/reports/provider-activity';
            break;
        case 'customer':
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            url = '/api/admin/reports/customer-history';
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (params.toString()) url += '?' + params.toString();
            break;
        case 'earnings':
            const earningsStart = document.getElementById('startDate').value;
            const earningsEnd = document.getElementById('endDate').value;
            url = '/api/admin/reports/provider-earnings';
            if (earningsStart) params.append('start_date', earningsStart);
            if (earningsEnd) params.append('end_date', earningsEnd);
            if (params.toString()) url += '?' + params.toString();
            break;
    }
    
    // Show loading
    document.getElementById('loadingMessage').style.display = 'block';
    document.getElementById('reportContent').style.display = 'none';
    document.getElementById('reportSummary').style.display = 'none';
    
    try {
        const response = await fetch(url, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Failed to generate report');
        }
        
        const data = await response.json();
        currentReportData = data;
        
        // Hide loading, show content
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('reportContent').style.display = 'block';
        
        // Render report based on type
        renderReport(reportType, data);
        
    } catch (error) {
        document.getElementById('loadingMessage').innerHTML = 
            `<div style="text-align: center; padding: 60px 20px; color: #dc3545;"><p style="font-size: 1.1rem; margin: 0;">Error: ${error.message}</p></div>`;
        document.getElementById('loadingMessage').style.display = 'block';
        document.getElementById('reportContent').style.display = 'none';
    }
}

function renderReport(type, data) {
    const titleEl = document.getElementById('reportTitle');
    const tableEl = document.getElementById('reportTable');
    const summaryEl = document.getElementById('reportSummary');
    
    switch(type) {
        case 'daily':
            titleEl.textContent = `Daily Bookings Report - ${formatDate(data.date)}`;
            renderDailyBookings(data, tableEl, summaryEl);
            break;
        case 'provider':
            titleEl.textContent = 'Provider Activity Report';
            renderProviderActivity(data, tableEl, summaryEl);
            break;
        case 'customer':
            titleEl.textContent = 'Customer History Report';
            renderCustomerHistory(data, tableEl, summaryEl);
            break;
        case 'earnings':
            titleEl.textContent = 'Provider Earnings Report';
            renderProviderEarnings(data, tableEl, summaryEl);
            break;
    }
}

function renderDailyBookings(data, tableEl, summaryEl) {
    let html = '<table style="width: 100%; border-collapse: collapse; min-width: 800px;">';
    html += '<thead><tr style="background: #f8f9fa;">';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Booking ID</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Customer</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Provider</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Service</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Time</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Amount</th>';
    html += '</tr></thead><tbody>';
    
    if (data.bookings && data.bookings.length > 0) {
        data.bookings.forEach(booking => {
            const statusColors = {
                'pending': '#ffc107',
                'accepted': '#17a2b8',
                'completed': '#28a745',
                'rejected': '#dc3545',
                'cancelled': '#6c757d'
            };
            const statusColor = statusColors[booking.status] || '#6c757d';
            const bookingTime = booking.booking_time ? new Date(booking.booking_time).toLocaleString() : 'N/A';
            
            html += `<tr style="border-bottom: 1px solid #eee;">`;
            html += `<td style="padding: 12px;">${booking._id.substring(0, 8)}...</td>`;
            html += `<td style="padding: 12px;">${booking.customer_name || 'Unknown'}</td>`;
            html += `<td style="padding: 12px;">${booking.provider_name || 'Unknown'}</td>`;
            html += `<td style="padding: 12px;">${(booking.service_type || '').replace('_', ' ')}</td>`;
            html += `<td style="padding: 12px;">${bookingTime}</td>`;
            html += `<td style="padding: 12px;"><span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${booking.status || 'pending'}</span></td>`;
            html += `<td style="padding: 12px;">₱${(booking.final_price || booking.price || 0).toLocaleString()}</td>`;
            html += `</tr>`;
        });
    } else {
        html += '<tr><td colspan="7" style="padding: 20px; text-align: center; color: #666;">No bookings found for this date.</td></tr>';
    }
    
    html += '</tbody></table>';
    tableEl.innerHTML = html;
    
    // Summary
    summaryEl.innerHTML = `
        <div class="stat-card">
            <div class="stat-value" style="color: #0070f3;">${data.total_bookings || 0}</div>
            <div class="stat-label">Total Bookings</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #28a745;">₱${(data.total_revenue || 0).toLocaleString()}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #ffc107;">${data.status_breakdown?.pending || 0}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #28a745;">${data.status_breakdown?.completed || 0}</div>
            <div class="stat-label">Completed</div>
        </div>
    `;
    summaryEl.style.display = 'grid';
}

function renderProviderActivity(data, tableEl, summaryEl) {
    let html = '<table style="width: 100%; border-collapse: collapse; min-width: 800px;">';
    html += '<thead><tr style="background: #f8f9fa;">';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Provider</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Location</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Status</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Total Jobs</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Avg Rating</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Total Earnings</th>';
    html += '</tr></thead><tbody>';
    
    if (data.providers && data.providers.length > 0) {
        data.providers.forEach(provider => {
            html += `<tr style="border-bottom: 1px solid #eee;">`;
            html += `<td style="padding: 12px;"><strong>${provider.company_name || provider.provider_name}</strong><br><small>${provider.provider_name}</small></td>`;
            html += `<td style="padding: 12px;">${provider.location || 'N/A'}</td>`;
            html += `<td style="padding: 12px;"><span style="background: ${provider.is_verified ? '#28a745' : '#ffc107'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${provider.is_verified ? 'Verified' : 'Pending'}</span></td>`;
            html += `<td style="padding: 12px;">${provider.total_jobs || 0}</td>`;
            html += `<td style="padding: 12px;">⭐ ${provider.avg_rating || 0}</td>`;
            html += `<td style="padding: 12px;">₱${(provider.total_earnings || 0).toLocaleString()}</td>`;
            html += `</tr>`;
        });
    } else {
        html += '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #666;">No providers found.</td></tr>';
    }
    
    html += '</tbody></table>';
    tableEl.innerHTML = html;
    
    summaryEl.innerHTML = `
        <div class="stat-card">
            <div class="stat-value" style="color: #0070f3;">${data.total_providers || 0}</div>
            <div class="stat-label">Total Providers</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #28a745;">${data.verified_providers || 0}</div>
            <div class="stat-label">Verified Providers</div>
        </div>
    `;
    summaryEl.style.display = 'grid';
}

function renderCustomerHistory(data, tableEl, summaryEl) {
    let html = '<table style="width: 100%; border-collapse: collapse; min-width: 800px;">';
    html += '<thead><tr style="background: #f8f9fa;">';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Customer</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Email</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Total Bookings</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Completed</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Total Spent</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Reviews Given</th>';
    html += '</tr></thead><tbody>';
    
    if (data.customers && data.customers.length > 0) {
        data.customers.forEach(customer => {
            html += `<tr style="border-bottom: 1px solid #eee;">`;
            html += `<td style="padding: 12px;"><strong>${customer.customer_name || 'Unknown'}</strong></td>`;
            html += `<td style="padding: 12px;">${customer.email || 'N/A'}</td>`;
            html += `<td style="padding: 12px;">${customer.total_bookings || 0}</td>`;
            html += `<td style="padding: 12px;">${customer.completed_bookings || 0}</td>`;
            html += `<td style="padding: 12px;">₱${(customer.total_spent || 0).toLocaleString()}</td>`;
            html += `<td style="padding: 12px;">${customer.reviews_given || 0}</td>`;
            html += `</tr>`;
        });
    } else {
        html += '<tr><td colspan="6" style="padding: 20px; text-align: center; color: #666;">No customers found.</td></tr>';
    }
    
    html += '</tbody></table>';
    tableEl.innerHTML = html;
    
    const totalSpent = data.customers ? data.customers.reduce((sum, c) => sum + (c.total_spent || 0), 0) : 0;
    summaryEl.innerHTML = `
        <div class="stat-card">
            <div class="stat-value" style="color: #0070f3;">${data.total_customers || 0}</div>
            <div class="stat-label">Total Customers</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #28a745;">₱${totalSpent.toLocaleString()}</div>
            <div class="stat-label">Total Customer Spending</div>
        </div>
    `;
    summaryEl.style.display = 'grid';
}

function renderProviderEarnings(data, tableEl, summaryEl) {
    let html = '<table style="width: 100%; border-collapse: collapse; min-width: 800px;">';
    html += '<thead><tr style="background: #f8f9fa;">';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Provider</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Location</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Total Jobs</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Total Earnings</th>';
    html += '<th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Avg per Job</th>';
    html += '</tr></thead><tbody>';
    
    if (data.providers && data.providers.length > 0) {
        data.providers.forEach(provider => {
            html += `<tr style="border-bottom: 1px solid #eee;">`;
            html += `<td style="padding: 12px;"><strong>${provider.company_name || provider.provider_name}</strong><br><small>${provider.provider_name}</small></td>`;
            html += `<td style="padding: 12px;">${provider.location || 'N/A'}</td>`;
            html += `<td style="padding: 12px;">${provider.total_jobs || 0}</td>`;
            html += `<td style="padding: 12px;"><strong>₱${(provider.total_earnings || 0).toLocaleString()}</strong></td>`;
            html += `<td style="padding: 12px;">₱${(provider.avg_earnings_per_job || 0).toLocaleString()}</td>`;
            html += `</tr>`;
        });
    } else {
        html += '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #666;">No earnings data found.</td></tr>';
    }
    
    html += '</tbody></table>';
    tableEl.innerHTML = html;
    
    summaryEl.innerHTML = `
        <div class="stat-card">
            <div class="stat-value" style="color: #0070f3;">${data.total_providers || 0}</div>
            <div class="stat-label">Providers with Earnings</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #28a745;">₱${(data.total_platform_earnings || 0).toLocaleString()}</div>
            <div class="stat-label">Total Platform Earnings</div>
        </div>
    `;
    summaryEl.style.display = 'grid';
}

function exportReport() {
    if (!currentReportData) {
        alert('Please generate a report first');
        return;
    }
    alert('CSV export feature coming soon!');
}

function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

// Initialize with today's date
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reportDate').value = today;
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
});
</script>
{% endblock %}