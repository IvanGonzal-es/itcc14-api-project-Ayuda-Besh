<!-- templates/admin/dispute_management.html -->
{% extends "base.html" %}

{% block title %}Dispute Management - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="customer-dashboard">
    <div class="dashboard-header">
        <h1>Dispute Management</h1>
        <button class="btn btn-outline" onclick="window.location.href='/admin/dashboard'">
            ‚Üê Back to Dashboard
        </button>
    </div>

    <div class="stats-grid" style="margin-bottom: 30px;">
        <div class="stat-card">
            <div class="stat-value" style="color: #dc3545;"><span id="openDisputesCount">0</span></div>
            <div class="stat-label">Open Disputes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" style="color: #ffc107;"><span id="pendingReportsCount">0</span></div>
            <div class="stat-label">Pending Reports</div>
        </div>
    </div>

    <div class="content-section" id="disputes">
        <div class="section-header">
            <h2>Open Disputes</h2>
            <button class="btn btn-outline" onclick="loadDisputes()" style="padding: 10px 16px; font-size: 0.9rem;">
                üîÑ Refresh
            </button>
        </div>
        <p style="text-align: center; color: #6c757d; padding: 40px;">Loading disputes...</p>
    </div>

    <div class="content-section" id="reports" style="margin-top: 30px;">
        <div class="section-header">
            <h2>Service Reports</h2>
            <button class="btn btn-outline" onclick="loadReports()" style="padding: 10px 16px; font-size: 0.9rem;">
                üîÑ Refresh
            </button>
        </div>
        <p style="text-align: center; color: #6c757d; padding: 40px;">Loading reports...</p>
    </div>

    <div class="content-section" id="resolvedDisputes" style="margin-top: 30px;">
        <div class="section-header">
            <h2>Resolved Disputes</h2>
        </div>
        <p style="text-align: center; color: #6c757d; padding: 40px;">Loading resolved disputes...</p>
    </div>
</div>

<script>
async function loadDisputes() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/admin/disputes', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const disputes = await response.json();
            const openDisputes = disputes.filter(d => d.status === 'open');
            const resolvedDisputes = disputes.filter(d => d.status === 'resolved');
            
            document.getElementById('openDisputesCount').textContent = openDisputes.length;
            
            if (openDisputes.length === 0) {
                document.getElementById('disputes').innerHTML = `
                    <div class="section-header">
                        <h2>Open Disputes</h2>
                        <button class="btn btn-outline" onclick="loadDisputes()" style="padding: 10px 16px; font-size: 0.9rem;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <p style="font-size: 1.1rem; margin: 0;">No open disputes.</p>
                    </div>
                `;
            } else {
                let openHtml = '<div style="display: grid; gap: 20px; margin-top: 20px;">';
                
                openDisputes.forEach(dispute => {
                    const date = new Date(dispute.created_at).toLocaleDateString('en-US', {
                        month: 'long', day: 'numeric', year: 'numeric'
                    });
                    openHtml += `
                        <div class="booking-card-detailed" style="border-color: #dc3545;">
                            <div class="booking-header-detailed">
                                <div style="flex-grow: 1;">
                                    <h3 class="booking-title-detailed">Dispute #${dispute.booking_id.substring(0, 8)}</h3>
                                    <span class="status-badge status-rejected">Open</span>
                                </div>
                            </div>
                            <div class="booking-info-grid">
                                <div class="info-item">
                                    <strong>Customer:</strong>
                                    <span>${dispute.customer_name || 'Unknown'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Provider:</strong>
                                    <span>${dispute.provider_company_name || dispute.provider_name || 'Unknown'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Date:</strong>
                                    <span>${date}</span>
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <strong>Issue:</strong>
                                    <span>${dispute.description}</span>
                                </div>
                            </div>
                            <div class="booking-actions">
                                <button onclick="viewDisputeDetails('${dispute._id}')" class="btn btn-primary">
                                    View Details
                                </button>
                                <button onclick="resolveDispute('${dispute._id}')" class="btn btn-primary" style="background: #28a745;">
                                    ‚úì Resolve
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                openHtml += '</div>';
                document.getElementById('disputes').innerHTML = `
                    <div class="section-header">
                        <h2>Open Disputes</h2>
                        <button class="btn btn-outline" onclick="loadDisputes()" style="padding: 10px 16px; font-size: 0.9rem;">
                            üîÑ Refresh
                        </button>
                    </div>
                    ${openHtml}
                `;
            }
            
            // Resolved disputes
            if (resolvedDisputes.length === 0) {
                document.getElementById('resolvedDisputes').innerHTML = `
                    <div class="section-header">
                        <h2>Resolved Disputes</h2>
                    </div>
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <p style="font-size: 1.1rem; margin: 0;">No resolved disputes.</p>
                    </div>
                `;
            } else {
                let resolvedHtml = '<div style="display: grid; gap: 20px; margin-top: 20px;">';
                
                resolvedDisputes.forEach(dispute => {
                    const date = new Date(dispute.resolved_at || dispute.created_at).toLocaleDateString('en-US', {
                        month: 'long', day: 'numeric', year: 'numeric'
                    });
                    resolvedHtml += `
                        <div class="booking-card-detailed" style="border-color: #28a745; background: #f8fff8;">
                            <div class="booking-header-detailed">
                                <div style="flex-grow: 1;">
                                    <h3 class="booking-title-detailed">Dispute #${dispute.booking_id.substring(0, 8)}</h3>
                                    <span class="status-badge status-accepted">‚úì Resolved</span>
                                </div>
                            </div>
                            <div class="booking-info-grid">
                                <div class="info-item">
                                    <strong>Customer:</strong>
                                    <span>${dispute.customer_name || 'Unknown'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Provider:</strong>
                                    <span>${dispute.provider_name || 'Unknown'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Resolved Date:</strong>
                                    <span>${date}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                resolvedHtml += '</div>';
                document.getElementById('resolvedDisputes').innerHTML = `
                    <div class="section-header">
                        <h2>Resolved Disputes</h2>
                    </div>
                    ${resolvedHtml}
                `;
            }
        }
    } catch (error) {
        console.error('Error loading disputes:', error);
        document.getElementById('disputes').innerHTML = `
            <div class="section-header">
                <h2>Open Disputes</h2>
            </div>
            <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
                <p style="font-size: 1.1rem; margin: 0;">Failed to load disputes. Please try again.</p>
            </div>
        `;
    }
}

async function loadReports() {
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
        const response = await fetch('/api/admin/reports', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            const allReports = await response.json();
            // Separate checked and unchecked reports
            const uncheckedReports = allReports.filter(r => !r.checked);
            const checkedReports = allReports.filter(r => r.checked);
            
            document.getElementById('pendingReportsCount').textContent = uncheckedReports.length;
            
            if (allReports.length === 0) {
                document.getElementById('reports').innerHTML = `
                    <div class="section-header">
                        <h2>Service Reports</h2>
                        <button class="btn btn-outline" onclick="loadReports()" style="padding: 10px 16px; font-size: 0.9rem;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
                        <p style="font-size: 1.1rem; margin: 0;">No reports found.</p>
                    </div>
                `;
            } else {
                let reportsHtml = '<div style="display: grid; gap: 20px; margin-top: 20px;">';
                
                allReports.forEach(report => {
                    const date = new Date(report.created_at).toLocaleDateString('en-US', {
                        month: 'long', day: 'numeric', year: 'numeric'
                    });
                    reportsHtml += `
                        <div class="booking-card-detailed" style="border-color: ${report.checked ? '#28a745' : '#ffc107'};">
                            <div class="booking-header-detailed">
                                <div style="flex-grow: 1;">
                                    <h3 class="booking-title-detailed">Report #${report.booking_id.substring(0, 8)}</h3>
                                    ${report.checked ? 
                                        '<span class="status-badge status-accepted">‚úì Checked</span>' : 
                                        '<span class="status-badge status-pending">Pending Review</span>'
                                    }
                                </div>
                            </div>
                            <div class="booking-info-grid">
                                <div class="info-item">
                                    <strong>Customer:</strong>
                                    <span>${report.customer_name || 'Unknown'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Provider:</strong>
                                    <span>${report.provider_company_name || report.provider_name || 'Unknown'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Date:</strong>
                                    <span>${date}</span>
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <strong>Report Details:</strong>
                                    <span>${report.description || report.details || 'No details provided'}</span>
                                </div>
                            </div>
                            <div class="booking-actions">
                                <button onclick="viewReportDetails('${report._id}')" class="btn btn-primary">
                                    View Details
                                </button>
                                ${!report.checked ? `
                                    <button onclick="checkReport('${report._id}')" class="btn btn-primary" style="background: #28a745;">
                                        ‚úì Mark as Checked
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                reportsHtml += '</div>';
                document.getElementById('reports').innerHTML = `
                    <div class="section-header">
                        <h2>Service Reports <span style="font-size: 0.9rem; color: #6c757d; font-weight: normal;">(${uncheckedReports.length} unchecked, ${checkedReports.length} checked)</span></h2>
                        <button class="btn btn-outline" onclick="loadReports()" style="padding: 10px 16px; font-size: 0.9rem;">
                            üîÑ Refresh
                        </button>
                    </div>
                    ${reportsHtml}
                `;
            }
        }
    } catch (error) {
        console.error('Error loading reports:', error);
        document.getElementById('reports').innerHTML = `
            <div class="section-header">
                <h2>Service Reports</h2>
            </div>
            <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
                <p style="font-size: 1.1rem; margin: 0;">Failed to load reports. Please try again.</p>
            </div>
        `;
    }
}

let currentDisputeData = null;
let currentReportData = null;

async function viewDisputeDetails(disputeId) {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/disputes/${disputeId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            currentDisputeData = await response.json();
            displayDisputeDetailsModal(currentDisputeData);
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to load dispute details'));
        }
    } catch (error) {
        console.error('Error loading dispute details:', error);
        alert('Network error. Please try again.');
    }
}

async function viewReportDetails(reportId) {
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/reports/${reportId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
            currentReportData = await response.json();
            displayReportDetailsModal(currentReportData);
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to load report details'));
        }
    } catch (error) {
        console.error('Error loading report details:', error);
        alert('Network error. Please try again.');
    }
}

function displayDisputeDetailsModal(dispute) {
    const bookingDate = dispute.booking_details && dispute.booking_details.booking_time
        ? new Date(dispute.booking_details.booking_time).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
        })
        : 'N/A';
    
    const createdDate = new Date(dispute.created_at).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
    });
    
    const responses = dispute.responses || [];
    
    let modalHtml = `
        <div id="disputeDetailsModal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: #333;">Dispute Details</h2>
                    <span onclick="closeDisputeDetailsModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
                </div>
                <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #d9534f; padding-bottom: 5px;">Booking Information</h3>
                            <p style="margin: 5px 0;"><strong>Booking ID:</strong> ${dispute.booking_id.substring(0, 8)}</p>
                            <p style="margin: 5px 0;"><strong>Service Type:</strong> ${dispute.booking_details ? dispute.booking_details.service_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Scheduled Time:</strong> ${bookingDate}</p>
                            <p style="margin: 5px 0;"><strong>Service Address:</strong> ${dispute.booking_details ? dispute.booking_details.service_address || 'N/A' : 'N/A'}</p>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #d9534f; padding-bottom: 5px;">Parties Involved</h3>
                            <p style="margin: 5px 0;"><strong>Customer:</strong> ${dispute.customer_name || 'Unknown'}</p>
                            <p style="margin: 5px 0;"><strong>Customer Email:</strong> ${dispute.customer_email || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Provider (Company):</strong> ${dispute.provider_company_name || dispute.provider_name || 'Unknown'}</p>
                            <p style="margin: 5px 0;"><strong>Provider (Owner):</strong> ${dispute.provider_owner_name || 'Unknown'}</p>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #d9534f; padding-bottom: 5px;">Dispute Information</h3>
                            <p style="margin: 5px 0;"><strong>Status:</strong> <span style="background: #d9534f; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${dispute.status.charAt(0).toUpperCase() + dispute.status.slice(1)}</span></p>
                            <p style="margin: 5px 0;"><strong>Created:</strong> ${createdDate}</p>
                            <p style="margin: 5px 0;"><strong>Description:</strong></p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 5px; line-height: 1.6;">
                                ${dispute.description}
                            </div>
                        </div>
                        ${responses.length > 0 ? `
                            <div>
                                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #d9534f; padding-bottom: 5px;">Provider Responses</h3>
                                ${responses.map((response, idx) => {
                                    const responseDate = new Date(response.responded_at).toLocaleDateString('en-US', {
                                        month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
                                    });
                                    return `
                                        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 10px; border-left: 4px solid #28a745;">
                                            <p style="margin: 0 0 5px 0; font-size: 12px; color: #666;">Response ${idx + 1} - ${responseDate}</p>
                                            <p style="margin: 0; line-height: 1.6;">${response.text}</p>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ${dispute.status === 'open' ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <label for="resolutionNotes" style="display: block; margin-bottom: 5px; font-weight: 600;">Resolution Notes (Optional):</label>
                            <textarea id="resolutionNotes" rows="3" placeholder="Add notes about how this dispute was resolved..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
                            <button onclick="resolveDisputeWithNotes('${dispute._id}')" 
                                    style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                Resolve Dispute
                            </button>
                        </div>
                    ` : dispute.status === 'resolved' && dispute.resolution_notes ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <h4 style="margin: 0 0 10px 0;">Resolution Notes</h4>
                            <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; line-height: 1.6;">${dispute.resolution_notes}</p>
                            </div>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('disputeDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDisputeDetailsModal() {
    const modal = document.getElementById('disputeDetailsModal');
    if (modal) {
        modal.remove();
    }
    currentDisputeData = null;
}

async function resolveDisputeWithNotes(disputeId) {
    const resolutionNotes = document.getElementById('resolutionNotes').value.trim();
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/admin/disputes/${disputeId}/resolve`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ resolution_notes: resolutionNotes })
        });
        
        if (response.ok) {
            alert('‚úÖ Dispute resolved successfully!');
            closeDisputeDetailsModal();
            loadDisputes();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to resolve dispute'));
        }
    } catch (error) {
        console.error('Error resolving dispute:', error);
        alert('Network error. Please try again.');
    }
}

function displayReportDetailsModal(report) {
    const bookingDate = report.booking_details && report.booking_details.booking_time
        ? new Date(report.booking_details.booking_time).toLocaleDateString('en-US', {
            month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
        })
        : 'N/A';
    
    const createdDate = new Date(report.created_at).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit'
    });
    
    let modalHtml = `
        <div id="reportDetailsModal" style="display: block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
            <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; color: #333;">Report Details</h2>
                    <span onclick="closeReportDetailsModal()" style="color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
                </div>
                <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                    <div style="display: grid; gap: 20px;">
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 5px;">Booking Information</h3>
                            <p style="margin: 5px 0;"><strong>Booking ID:</strong> ${report.booking_id.substring(0, 8)}</p>
                            <p style="margin: 5px 0;"><strong>Service Type:</strong> ${report.booking_details ? report.booking_details.service_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Scheduled Time:</strong> ${bookingDate}</p>
                            <p style="margin: 5px 0;"><strong>Service Address:</strong> ${report.booking_details ? report.booking_details.service_address || 'N/A' : 'N/A'}</p>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 5px;">Parties Involved</h3>
                            <p style="margin: 5px 0;"><strong>Customer:</strong> ${report.customer_name || 'Unknown'}</p>
                            <p style="margin: 5px 0;"><strong>Customer Email:</strong> ${report.customer_email || 'N/A'}</p>
                            <p style="margin: 5px 0;"><strong>Provider (Company):</strong> ${report.provider_company_name || report.provider_name || 'Unknown'}</p>
                            <p style="margin: 5px 0;"><strong>Provider (Owner):</strong> ${report.provider_owner_name || 'Unknown'}</p>
                        </div>
                        <div>
                            <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #ffc107; padding-bottom: 5px;">Report Information</h3>
                            <p style="margin: 5px 0;"><strong>Status:</strong> <span style="background: #ffc107; color: #333; padding: 4px 8px; border-radius: 12px; font-size: 12px;">${report.status.charAt(0).toUpperCase() + report.status.slice(1)}</span></p>
                            <p style="margin: 5px 0;"><strong>Checked:</strong> ${report.checked ? '<span style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">‚úì Checked</span>' : '<span style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;">Not Checked</span>'}</p>
                            ${report.checked && report.checked_at ? `
                                <p style="margin: 5px 0;"><strong>Checked At:</strong> ${new Date(report.checked_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                            ` : ''}
                            <p style="margin: 5px 0;"><strong>Type:</strong> ${report.type ? report.type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Service Report'}</p>
                            <p style="margin: 5px 0;"><strong>Created:</strong> ${createdDate}</p>
                            <p style="margin: 5px 0;"><strong>Report Details:</strong></p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 5px; line-height: 1.6;">
                                ${report.description || report.details || 'No details provided'}
                            </div>
                            ${report.checked && report.check_notes ? `
                                <p style="margin: 15px 0 5px 0;"><strong>Check Notes:</strong></p>
                                <div style="background: #d4edda; padding: 15px; border-radius: 4px; border-left: 4px solid #28a745; line-height: 1.6;">
                                    ${report.check_notes}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    ${!report.checked ? `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                            <label for="checkNotes" style="display: block; margin-bottom: 5px; font-weight: 600;">Check Notes (Optional):</label>
                            <textarea id="checkNotes" rows="3" placeholder="Add notes about reviewing this report..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
                            <button onclick="checkReportWithNotes('${report._id}')" 
                                    style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                                Mark as Checked
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('reportDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeReportDetailsModal() {
    const modal = document.getElementById('reportDetailsModal');
    if (modal) {
        modal.remove();
    }
    currentReportData = null;
}

async function checkReport(reportId) {
    if (!confirm('Mark this report as checked?')) return;
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/admin/reports/${reportId}/check`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        if (response.ok) {
            alert('Report marked as checked successfully!');
            closeReportDetailsModal();
            loadReports();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to check report'));
        }
    } catch (error) {
        console.error('Error checking report:', error);
        alert('Network error. Please try again.');
    }
}

async function checkReportWithNotes(reportId) {
    const checkNotes = document.getElementById('checkNotes').value.trim();
    
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/admin/reports/${reportId}/check`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes: checkNotes })
        });
        
        if (response.ok) {
            alert('Report marked as checked successfully!');
            closeReportDetailsModal();
            loadReports();
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to check report'));
        }
    } catch (error) {
        console.error('Error checking report:', error);
        alert('Network error. Please try again.');
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const disputeModal = document.getElementById('disputeDetailsModal');
    const reportModal = document.getElementById('reportDetailsModal');
    if (event.target == disputeModal) {
        closeDisputeDetailsModal();
    }
    if (event.target == reportModal) {
        closeReportDetailsModal();
    }
}

async function resolveDispute(disputeId) {
    // Open the dispute details modal first to allow adding resolution notes
    await viewDisputeDetails(disputeId);
}

function escalateDispute(disputeId) {
    if (!confirm('Escalate this dispute to senior admin?')) return;
    alert('Dispute escalated successfully!');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadDisputes();
    loadReports();
});
</script>
{% endblock %}