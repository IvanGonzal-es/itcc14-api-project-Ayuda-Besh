<!-- templates/admin/provider_verification.html -->
{% extends "base.html" %}

{% block title %}Provider Verification - AyudaBesh{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/customer_dashboard.css') }}">
{% endblock %}

{% block extra_js %}
<script>
// Load admin profile picture on all admin pages
document.addEventListener('DOMContentLoaded', () => {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const pictureElement = document.getElementById('adminProfilePicture');
    if (pictureElement && user.profile_picture) {
        pictureElement.src = user.profile_picture;
    }
    const nameElement = document.getElementById('adminName');
    if (nameElement && user.fullName) {
        nameElement.textContent = user.fullName;
    }
});
</script>
{% endblock %}

{% block content %}
<div class="customer-dashboard">
    <div class="dashboard-header">
        <h1>Provider Verification</h1>
        <button class="btn btn-outline" onclick="window.location.href='/admin/dashboard'">
            ‚Üê Back to Dashboard
        </button>
    </div>

    <div class="content-section" id="pendingProviders">
        <div class="section-header">
            <h2>Pending Verification</h2>
            <button class="btn btn-outline" onclick="loadProviders()" style="padding: 10px 16px; font-size: 0.9rem;">
                üîÑ Refresh
            </button>
        </div>
        <p style="text-align: center; color: #6c757d; padding: 40px;">Loading providers...</p>
    </div>

    <div class="content-section" id="verifiedProviders" style="margin-top: 30px;">
        <div class="section-header">
            <h2>Verified Providers</h2>
        </div>
        <p style="text-align: center; color: #6c757d; padding: 40px;">Loading providers...</p>
    </div>
</div>

<!-- Provider Details Modal (for Verification) -->
<div id="providerModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
            <h2 style="margin: 0; color: #212529; font-size: 1.5rem; font-weight: 700;">Provider Details</h2>
            <span id="closeModal" style="color: #6c757d; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 20px; transition: color 0.2s;" onclick="closeProviderModal()" onmouseover="this.style.color='#dc3545'" onmouseout="this.style.color='#6c757d'">&times;</span>
        </div>
        <div id="providerModalContent" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
            <p style="text-align: center; color: #6c757d; padding: 40px;">Loading provider details...</p>
        </div>
        <div style="padding: 25px; border-top: 1px solid #e0e0e0; display: flex; gap: 12px; justify-content: flex-end; background: #f8f9fa;">
            <button onclick="closeProviderModal()" class="btn btn-outline">
                Cancel
            </button>
            <button id="confirmVerifyBtn" onclick="confirmVerification()" class="btn btn-primary" style="background: #28a745;">
                ‚úì Confirm Verification
            </button>
        </div>
    </div>
</div>

<!-- Provider Rejection Modal -->
<div id="rejectModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
        <div style="padding: 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #fff3cd 0%, #ffe0b2 100%);">
            <h2 style="margin: 0; color: #856404; font-size: 1.5rem; font-weight: 700;">‚ö†Ô∏è Reject Provider</h2>
            <span id="closeRejectModal" style="color: #6c757d; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 20px; transition: color 0.2s;" onclick="closeRejectModal()" onmouseover="this.style.color='#dc3545'" onmouseout="this.style.color='#6c757d'">&times;</span>
        </div>
        <div id="rejectModalContent" style="padding: 30px; max-height: 70vh; overflow-y: auto;">
            <p style="text-align: center; color: #6c757d; padding: 40px;">Loading provider details...</p>
        </div>
        <div style="padding: 25px; border-top: 1px solid #e0e0e0; background: #f8f9fa;">
            <div class="form-group" style="margin-bottom: 20px;">
                <label for="rejectionReason" style="display: block; margin-bottom: 8px; font-weight: 600; color: #212529;">
                    Rejection Reason <span style="color: #dc3545;">*</span>
                </label>
                <textarea 
                    id="rejectionReason" 
                    rows="4" 
                    placeholder="Please provide a reason for rejecting this provider (e.g., incomplete documentation, does not meet requirements, etc.)"
                    required
                ></textarea>
                <small style="color: #6c757d; display: block; margin-top: 6px; font-size: 0.85rem;">This reason will be stored and may be visible to the provider.</small>
            </div>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button onclick="closeRejectModal()" class="btn btn-outline">
                    Cancel
                </button>
                <button id="confirmRejectBtn" onclick="confirmRejection()" class="btn btn-outline" style="background: #dc3545; color: white; border-color: #dc3545;">
                    ‚úó Confirm Rejection
                </button>
            </div>
        </div>
    </div>
</div>

<script>
async function loadProviders() {
    const token = localStorage.getItem('token');
    if (!token) {
        console.error('No token found');
        return;
    }
    
    try {
        // Fetch pending providers
        const pendingResponse = await fetch('/api/admin/providers/pending', {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        // Fetch verified providers
        const verifiedResponse = await fetch('/api/admin/providers/verified', {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        let pendingHtml = '';
        let verifiedHtml = '';
        
        if (pendingResponse.ok) {
            const pendingProviders = await pendingResponse.json();
            
            if (pendingProviders.length === 0) {
                pendingHtml = '<div style="text-align: center; padding: 60px 20px; color: #6c757d;"><p style="font-size: 1.1rem; margin: 0;">No pending providers to verify.</p></div>';
            } else {
                pendingHtml = '<div style="display: grid; gap: 20px; margin-top: 20px;">';
                pendingProviders.forEach(provider => {
                                        const services = provider.services_offered && provider.services_offered.length > 0 
                                            ? provider.services_offered.map(s => s.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())).join(', ') 
                                            : 'No services specified';
                    pendingHtml += `
                        <div class="booking-card-detailed">
                            <div class="booking-header-detailed">
                                <div style="flex-grow: 1;">
                                    <h3 class="booking-title-detailed">${provider.fullName || 'N/A'}</h3>
                                    <span class="status-badge status-pending">Pending Verification</span>
                                </div>
                            </div>
                            <div class="booking-info-grid">
                                <div class="info-item">
                                    <strong>Email:</strong>
                                    <span>${provider.email || 'N/A'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Location:</strong>
                                    <span>${provider.location || 'Not specified'}</span>
                                </div>
                                <div class="info-item" style="grid-column: 1 / -1;">
                                    <strong>Services Offered:</strong>
                                    <span>${services}</span>
                                </div>
                            </div>
                            <div class="booking-actions">
                                <button onclick="viewProviderDetails('${provider._id}')" class="btn btn-primary" style="margin-right: 8px;">
                                    View Details
                                </button>
                                <button onclick="verifyProvider('${provider._id}')" class="btn btn-primary" style="background: #28a745; margin-right: 8px;">
                                    ‚úì Verify
                                </button>
                                <button onclick="rejectProvider('${provider._id}')" class="btn btn-outline" style="background: #dc3545; color: white; border-color: #dc3545; margin-right: 8px;">
                                    ‚úó Reject
                                </button>
                                ${provider.account_disabled ? `
                                    <button onclick="enableAccount('${provider._id}', '${provider.fullName || 'Provider'}')" class="btn btn-outline" style="background: #28a745; color: white; border-color: #28a745; margin-right: 8px;">
                                        ‚úì Enable
                                            </button>
                                ` : `
                                    <button onclick="disableAccount('${provider._id}', '${provider.fullName || 'Provider'}')" class="btn btn-outline" style="background: #ffc107; color: #212529; border-color: #ffc107; margin-right: 8px;">
                                        ‚ö†Ô∏è Disable
                                            </button>
                                `}
                                <button onclick="deleteProvider('${provider._id}', '${provider.fullName || 'Provider'}')" class="btn btn-outline" style="background: #6c757d; color: white; border-color: #6c757d;">
                                    üóëÔ∏è Delete
                                            </button>
                            </div>
                        </div>
                                `;
                });
                pendingHtml += '</div>';
            }
        } else {
            // Get error details
            let errorMsg = 'Error loading pending providers.';
            try {
                const errorData = await pendingResponse.json();
                errorMsg = errorData.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${pendingResponse.status}: ${pendingResponse.statusText}`;
            }
            pendingHtml = `<p style="padding: 20px; color: #d9534f;">${errorMsg}</p>`;
            console.error('Pending providers error:', errorMsg, pendingResponse.status);
        }
        
        if (verifiedResponse.ok) {
            const verifiedProviders = await verifiedResponse.json();
            
            if (verifiedProviders.length === 0) {
                verifiedHtml = '<div style="text-align: center; padding: 60px 20px; color: #6c757d;"><p style="font-size: 1.1rem; margin: 0;">No verified providers yet.</p></div>';
            } else {
                verifiedHtml = '<div style="display: grid; gap: 20px; margin-top: 20px;">';
                verifiedProviders.forEach(provider => {
                                        const services = provider.services_offered && provider.services_offered.length > 0 
                                            ? provider.services_offered.map(s => s.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())).join(', ') 
                                            : 'No services specified';
                    const rating = provider.rating > 0 ? `‚≠ê ${provider.rating.toFixed(1)}/5` : 'No ratings yet';
                    verifiedHtml += `
                        <div class="booking-card-detailed">
                            <div class="booking-header-detailed">
                                <div style="flex-grow: 1;">
                                    <h3 class="booking-title-detailed">${provider.fullName || 'N/A'}</h3>
                                    <span class="status-badge status-accepted">‚úì Verified</span>
                                </div>
                            </div>
                            <div class="booking-info-grid">
                                <div class="info-item">
                                    <strong>Services:</strong>
                                    <span>${services}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Rating:</strong>
                                    <span>${rating}</span>
                                </div>
                                <div class="info-item">
                                    <strong>Total Jobs:</strong>
                                    <span>${provider.total_jobs || 0}</span>
                                </div>
                            </div>
                            <div class="booking-actions">
                                ${provider.account_disabled ? `
                                    <button onclick="enableAccount('${provider._id}', '${provider.fullName || 'Provider'}')" class="btn btn-outline" style="background: #28a745; color: white; border-color: #28a745; margin-right: 8px;">
                                        ‚úì Enable Account
                                    </button>
                                ` : `
                                    <button onclick="disableAccount('${provider._id}', '${provider.fullName || 'Provider'}')" class="btn btn-outline" style="background: #ffc107; color: #212529; border-color: #ffc107; margin-right: 8px;">
                                        ‚ö†Ô∏è Disable Account
                                    </button>
                                `}
                                <button onclick="deleteProvider('${provider._id}', '${provider.fullName || 'Provider'}')" class="btn btn-outline" style="background: #6c757d; color: white; border-color: #6c757d;">
                                    üóëÔ∏è Delete
                                            </button>
                            </div>
                        </div>
                                `;
                });
                verifiedHtml += '</div>';
            }
        } else {
            // Get error details
            let errorMsg = 'Error loading verified providers.';
            try {
                const errorData = await verifiedResponse.json();
                errorMsg = errorData.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${verifiedResponse.status}: ${verifiedResponse.statusText}`;
            }
            verifiedHtml = `<p style="padding: 20px; color: #d9534f;">${errorMsg}</p>`;
            console.error('Verified providers error:', errorMsg, verifiedResponse.status);
        }
        
        document.getElementById('pendingProviders').innerHTML = `
            <div class="section-header">
                <h2>Pending Verification</h2>
                <button class="btn btn-outline" onclick="loadProviders()" style="padding: 10px 16px; font-size: 0.9rem;">
                    üîÑ Refresh
                </button>
            </div>
            ${pendingHtml}
        `;
        document.getElementById('verifiedProviders').innerHTML = `
            <div class="section-header">
                <h2>Verified Providers</h2>
            </div>
            ${verifiedHtml}
        `;
    } catch (error) {
        console.error('Error loading providers:', error);
        document.getElementById('pendingProviders').innerHTML = `
            <div class="section-header">
                <h2>Pending Verification</h2>
            </div>
            <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
                <p style="font-size: 1.1rem; margin: 0;">Failed to load providers. Please try again.</p>
            </div>
        `;
        document.getElementById('verifiedProviders').innerHTML = `
            <div class="section-header">
                <h2>Verified Providers</h2>
            </div>
            <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
                <p style="font-size: 1.1rem; margin: 0;">Failed to load providers. Please try again.</p>
            </div>
        `;
    }
}

let currentProviderId = null;
let currentProviderData = null;

async function verifyProvider(providerId) {
    currentProviderId = providerId;
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    // Show loading state
    document.getElementById('providerModalContent').innerHTML = '<p>Loading provider details...</p>';
    document.getElementById('providerModal').style.display = 'block';
    
    try {
        // Fetch provider details
        const response = await fetch(`/api/admin/providers/${providerId}`, {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            currentProviderData = await response.json();
            displayProviderDetails(currentProviderData);
        } else {
            let errorMsg = 'Failed to load provider details.';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${response.status}: ${response.statusText}`;
            }
            document.getElementById('providerModalContent').innerHTML = `<p style="color: #d9534f;">${errorMsg}</p>`;
            console.error('Load provider details error:', errorMsg, response.status);
        }
    } catch (error) {
        console.error('Network error:', error);
        document.getElementById('providerModalContent').innerHTML = '<p style="color: #d9534f;">Network error. Please check your connection and try again.</p>';
    }
}

function displayProviderDetails(provider) {
    const services = provider.services_offered && provider.services_offered.length > 0 
        ? provider.services_offered.map(s => s.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())).join(', ')
        : 'No services specified';
    
    const createdAt = provider.createdAt ? new Date(provider.createdAt).toLocaleDateString() : 'N/A';
    
    const html = `
        <div style="display: grid; gap: 20px;">
            <div>
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #0070f3; padding-bottom: 5px;">Personal Information</h3>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <strong style="color: #666;">Full Name:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.fullName || 'N/A'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Email:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.email || 'N/A'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Username:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.username || 'N/A'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Account Created:</strong>
                        <p style="margin: 5px 0; color: #333;">${createdAt}</p>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #0070f3; padding-bottom: 5px;">Service Information</h3>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <strong style="color: #666;">Services Offered:</strong>
                        <p style="margin: 5px 0; color: #333;">${services}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Location:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.location || 'Not specified'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Hourly Rate:</strong>
                        <p style="margin: 5px 0; color: #333;">‚Ç±${provider.hourly_rate || 0}/hour</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Description:</strong>
                        <p style="margin: 5px 0; color: #333; line-height: 1.6;">${provider.description || 'No description provided'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Service Radius:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.service_radius ? provider.service_radius + ' km' : 'Not specified'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Equipment/Tools:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.equipment || 'Not specified'}</p>
                    </div>
                </div>
            </div>
            
            <div>
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #0070f3; padding-bottom: 5px;">Verification Status</h3>
                <div>
                    <strong style="color: #666;">Status:</strong>
                    <span style="background: #ffc107; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px;">
                        Pending Verification
                    </span>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('providerModalContent').innerHTML = html;
}

function closeProviderModal() {
    document.getElementById('providerModal').style.display = 'none';
    currentProviderId = null;
    currentProviderData = null;
}

async function confirmVerification() {
    if (!currentProviderId) {
        alert('No provider selected.');
        return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    // Disable button during request
    const confirmBtn = document.getElementById('confirmVerifyBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Verifying...';
    
    try {
        const response = await fetch(`/api/admin/verify-provider/${currentProviderId}`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            closeProviderModal();
            alert('‚úÖ Provider verified successfully!');
            loadProviders(); // Refresh the list
        } else {
            let errorMsg = 'Failed to verify provider.';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${response.status}: ${response.statusText}`;
            }
            alert('Error: ' + errorMsg);
            console.error('Verify provider error:', errorMsg, response.status);
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm Verification';
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Network error. Please check your connection and try again.');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirm Verification';
    }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('providerModal');
    if (event.target == modal) {
        closeProviderModal();
    }
}

let currentRejectProviderId = null;
let currentRejectProviderData = null;

async function rejectProvider(providerId) {
    currentRejectProviderId = providerId;
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    // Show loading state
    document.getElementById('rejectModalContent').innerHTML = '<p>Loading provider details...</p>';
    document.getElementById('rejectModal').style.display = 'block';
    document.getElementById('rejectionReason').value = ''; // Clear previous reason
    
    try {
        // Fetch provider details
        const response = await fetch(`/api/admin/providers/${providerId}`, {
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            currentRejectProviderData = await response.json();
            displayRejectProviderDetails(currentRejectProviderData);
        } else {
            let errorMsg = 'Failed to load provider details.';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${response.status}: ${response.statusText}`;
            }
            document.getElementById('rejectModalContent').innerHTML = `<p style="color: #d9534f;">${errorMsg}</p>`;
            console.error('Load provider details error:', errorMsg, response.status);
        }
    } catch (error) {
        console.error('Network error:', error);
        document.getElementById('rejectModalContent').innerHTML = '<p style="color: #d9534f;">Network error. Please check your connection and try again.</p>';
    }
}

function displayRejectProviderDetails(provider) {
    const services = provider.services_offered && provider.services_offered.length > 0 
        ? provider.services_offered.map(s => s.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())).join(', ')
        : 'No services specified';
    
    const createdAt = provider.createdAt ? new Date(provider.createdAt).toLocaleDateString() : 'N/A';
    
    const html = `
        <div style="display: grid; gap: 20px;">
            <div style="background-color: #fff3cd; padding: 15px; border-radius: 4px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">‚ö†Ô∏è Warning:</strong>
                <p style="margin: 5px 0 0 0; color: #856404;">You are about to reject this provider. Please provide a clear reason below.</p>
            </div>
            
            <div>
                <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 2px solid #d9534f; padding-bottom: 5px;">Provider Information</h3>
                <div style="display: grid; gap: 10px;">
                    <div>
                        <strong style="color: #666;">Full Name:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.fullName || 'N/A'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Email:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.email || 'N/A'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Services Offered:</strong>
                        <p style="margin: 5px 0; color: #333;">${services}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Location:</strong>
                        <p style="margin: 5px 0; color: #333;">${provider.location || 'Not specified'}</p>
                    </div>
                    <div>
                        <strong style="color: #666;">Account Created:</strong>
                        <p style="margin: 5px 0; color: #333;">${createdAt}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('rejectModalContent').innerHTML = html;
}

function closeRejectModal() {
    document.getElementById('rejectModal').style.display = 'none';
    currentRejectProviderId = null;
    currentRejectProviderData = null;
    document.getElementById('rejectionReason').value = '';
}

async function confirmRejection() {
    if (!currentRejectProviderId) {
        alert('No provider selected.');
        return;
    }
    
    const rejectionReason = document.getElementById('rejectionReason').value.trim();
    if (!rejectionReason) {
        alert('Please provide a reason for rejection.');
        document.getElementById('rejectionReason').focus();
        return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    // Disable button during request
    const confirmBtn = document.getElementById('confirmRejectBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Rejecting...';
    
    try {
        const response = await fetch(`/api/admin/reject-provider/${currentRejectProviderId}`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ reason: rejectionReason })
        });
        
        if (response.ok) {
            const result = await response.json();
            closeRejectModal();
            alert('‚úÖ Provider rejected successfully.');
            loadProviders(); // Refresh the list
        } else {
            let errorMsg = 'Failed to reject provider.';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${response.status}: ${response.statusText}`;
            }
            alert('Error: ' + errorMsg);
            console.error('Reject provider error:', errorMsg, response.status);
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'Confirm Rejection';
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Network error. Please check your connection and try again.');
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Confirm Rejection';
    }
}

async function deleteProvider(providerId, providerName) {
    if (!confirm(`Are you sure you want to delete provider "${providerName}"?\n\nThis action cannot be undone. The provider account will be permanently removed.`)) {
        return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/delete-provider/${providerId}`, {
            method: 'DELETE',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            alert('‚úÖ Provider deleted successfully!');
            loadProviders(); // Refresh the list
        } else {
            let errorMsg = 'Failed to delete provider.';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${response.status}: ${response.statusText}`;
            }
            alert('Error: ' + errorMsg);
            console.error('Delete provider error:', errorMsg, response.status);
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Network error. Please check your connection and try again.');
    }
}

async function disableAccount(userId, userName) {
    const duration = prompt(`Disable account for "${userName}"?\n\nEnter duration in days (0 for permanent, or leave empty to cancel):`);
    if (duration === null) return;
    
    const durationDays = parseInt(duration) || 0;
    if (durationDays < 0) {
        alert('Duration must be 0 (permanent) or a positive number');
        return;
    }
    
    const reason = prompt('Enter reason for disabling (optional):') || 'Account disabled by admin';
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/accounts/${userId}/disable`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                duration_days: durationDays,
                reason: reason
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`‚úÖ Account disabled successfully! ${result.message}`);
            loadProviders(); // Refresh the list
        } else {
            let errorMsg = 'Failed to disable account.';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${response.status}: ${response.statusText}`;
            }
            alert('Error: ' + errorMsg);
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Network error. Please check your connection and try again.');
    }
}

async function enableAccount(userId, userName) {
    if (!confirm(`Enable account for "${userName}"?`)) {
        return;
    }
    
    const token = localStorage.getItem('token');
    if (!token) {
        alert('You are not logged in. Please log in again.');
        window.location.href = '/admin/login';
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/accounts/${userId}/enable`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            alert('‚úÖ Account enabled successfully!');
            loadProviders(); // Refresh the list
        } else {
            let errorMsg = 'Failed to enable account.';
            try {
                const error = await response.json();
                errorMsg = error.error || errorMsg;
            } catch (e) {
                errorMsg = `Error ${response.status}: ${response.statusText}`;
            }
            alert('Error: ' + errorMsg);
        }
    } catch (error) {
        console.error('Network error:', error);
        alert('Network error. Please check your connection and try again.');
    }
}

// Close reject modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('providerModal');
    const rejectModal = document.getElementById('rejectModal');
    if (event.target == modal) {
        closeProviderModal();
    }
    if (event.target == rejectModal) {
        closeRejectModal();
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', loadProviders);
</script>
{% endblock %}